<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Protocolo de Atención - Síndrome de Down</title>
    <link rel="icon" type="image/png" href="favicon.png">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background-color: #f0f9f9;
            color: #1a1a1a;
            line-height: 1.6;
            padding: 16px;
        }

        .container {
            max-width: 600px;
            margin: 0 auto;
            background-color: white;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 128, 128, 0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #20b2aa, #40e0d0);
            color: white;
            padding: 24px 20px;
            text-align: center;
        }

        .header h1 {
            font-size: 1.4rem;
            font-weight: 600;
            margin-bottom: 8px;
            line-height: 1.3;
        }

        .header p {
            font-size: 0.9rem;
            opacity: 0.9;
            margin-bottom: 12px;
        }

        .disclaimer {
            background-color: rgba(255, 255, 255, 0.1);
            padding: 12px;
            border-radius: 8px;
            font-size: 0.8rem;
            border-left: 3px solid white;
        }

        .loading-container {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 40px;
            background-color: white;
        }

        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #e0f2f1;
            border-top: 4px solid #20b2aa;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 16px;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        .error-container {
            background-color: #ffebee;
            border: 2px solid #f44336;
            border-radius: 12px;
            padding: 20px;
            margin: 20px;
            text-align: center;
        }

        .error-message {
            color: #c62828;
            font-weight: 500;
            margin-bottom: 12px;
        }

        .retry-button {
            background: #f44336;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
        }

        .retry-button:hover {
            background: #d32f2f;
        }

        .form-container {
            padding: 24px 20px 32px;
        }

        .rango-etario-info {
            background: linear-gradient(135deg, #f8fdfd, #e8f5f5);
            border: 2px solid #e0f2f1;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 24px;
            text-align: center;
        }

        .rango-etario-label {
            color: #2c5454;
            font-weight: 600;
            font-size: 1rem;
            margin-bottom: 8px;
        }

        .rango-etario-valor {
            color: #20b2aa;
            font-size: 1.3rem;
            font-weight: 700;
        }

        .edad-detalle {
            color: #666;
            font-size: 0.9rem;
            margin-top: 4px;
            font-style: italic;
        }

        /* Indicadores de cumplimiento */
        .cumplimiento-container {
            background: linear-gradient(135deg, #f8fdfd, #e8f5f5);
            border: 2px solid #e0f2f1;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 24px;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .cumplimiento-item {
            text-align: center;
        }

        .cumplimiento-label {
            color: #2c5454;
            font-weight: 600;
            font-size: 0.9rem;
            margin-bottom: 8px;
            display: block;
        }

        .cumplimiento-porcentaje {
            font-size: 2rem;
            font-weight: 700;
            color: #20b2aa;
            margin-bottom: 4px;
        }

        .cumplimiento-descripcion {
            font-size: 0.8rem;
            color: #666;
            line-height: 1.3;
        }

        .evaluaciones-container {
            margin-top: 24px;
        }

        .evaluacion-group {
            margin-bottom: 24px;
            border: 1px solid #e0f2f1;
            border-radius: 8px;
            overflow: hidden;
        }

        .evaluacion-header {
            background: linear-gradient(135deg, #20b2aa, #40e0d0);
            color: white;
            padding: 16px 20px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: 500;
            transition: background-color 0.3s ease;
        }

        .evaluacion-header:hover {
            background: linear-gradient(135deg, #1a9a96, #36c7c0);
        }

        .evaluacion-header.collapsed {
            background: linear-gradient(135deg, #4a9b9b, #6bb3b3);
        }

        /* Estilos para Evaluaciones Atrasadas */
        .evaluacion-header.atrasadas {
            background: linear-gradient(135deg, #ff8a65, #ffab40);
        }

        .evaluacion-header.atrasadas:hover {
            background: linear-gradient(135deg, #ff7043, #ff9800);
        }

        .evaluacion-header.atrasadas.collapsed {
            background: linear-gradient(135deg, #bf6b30, #cc7a00);
        }

        /* Estilos para Evaluaciones Vencidas */
        .evaluacion-header.vencidas {
            background: linear-gradient(135deg, #e57373, #ef5350);
        }

        .evaluacion-header.vencidas:hover {
            background: linear-gradient(135deg, #d32f2f, #f44336);
        }

        .evaluacion-header.vencidas.collapsed {
            background: linear-gradient(135deg, #c62828, #d32f2f);
        }

        /* Badge para conteo */
        .atrasadas-badge {
            background-color: #ff6b35;
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.7rem;
            font-weight: 600;
            margin-left: 8px;
        }

        .vencidas-badge {
            background-color: #d32f2f;
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.7rem;
            font-weight: 600;
            margin-left: 8px;
        }

        /* Colorear nombre y edad en items atrasados/vencidos */
        .evaluacion-name.atrasada {
            color: #e65100;
            font-weight: 500;
        }

        .evaluacion-name.vencida {
            color: #c62828;
            font-weight: 500;
        }

        .edad-info {
            font-size: 0.8rem;
            color: #ff6b35;
            margin-top: 4px;
            font-style: italic;
        }

        .edad-info.vencida {
            color: #d32f2f;
        }

        .collapse-icon {
            font-size: 1.2rem;
            transition: transform 0.3s ease;
        }

        .collapse-icon.rotated {
            transform: rotate(180deg);
        }

        .evaluacion-content {
            background-color: white;
            padding: 20px;
            display: block;
        }

        .evaluacion-content.collapsed {
            display: none;
        }

        .evaluacion-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 0;
            border-bottom: 1px solid #f0f0f0;
        }

        .evaluacion-item:last-child {
            border-bottom: none;
        }

        .evaluacion-name {
            flex: 1;
            font-size: 0.95rem;
            color: #2c5454;
            line-height: 1.4;
        }

        .estado-container {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .estado-slider {
            position: relative;
            width: 80px;
            height: 32px;
            background: linear-gradient(to right, #ff6b6b 0%, #ffd93d 50%, #20b2aa 100%);
            border-radius: 16px;
            cursor: pointer;
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .estado-thumb {
            position: absolute;
            top: 2px;
            left: 26px;
            /* Centro por defecto */
            width: 28px;
            height: 28px;
            background: white;
            border-radius: 50%;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
            transition: left 0.3s ease;
            cursor: pointer;
        }

        .estado-thumb.no-realizado {
            left: 2px;
        }

        .estado-thumb.no-disponible {
            left: 26px;
        }

        .estado-thumb.realizado {
            left: 50px;
        }

        .estado-label {
            font-size: 0.8rem;
            color: #666;
            min-width: 90px;
            font-weight: 500;
        }

        .estado-label.no-realizado {
            color: #ff6b6b;
        }

        .estado-label.no-disponible {
            color: #ffa500;
        }

        .estado-label.realizado {
            color: #20b2aa;
        }

        .button-container {
            display: flex;
            gap: 12px;
            margin-top: 32px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            flex: 1;
            min-width: 120px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #20b2aa, #40e0d0);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(32, 178, 170, 0.3);
        }

        .btn-secondary {
            background-color: white;
            color: #20b2aa;
            border: 2px solid #20b2aa;
        }

        .btn-secondary:hover {
            background-color: #f0f9f9;
        }

        /* Navegación por teclado */
        .estado-slider:focus {
            outline: 2px solid #20b2aa;
            outline-offset: 2px;
        }

        /* Mobile optimizations */
        @media (max-width: 480px) {
            body {
                padding: 8px;
            }

            .container {
                border-radius: 8px;
            }

            .header {
                padding: 20px 16px;
            }

            .header h1 {
                font-size: 1.2rem;
            }

            .form-container {
                padding: 20px 16px 28px;
            }

            .cumplimiento-container {
                grid-template-columns: 1fr;
                gap: 16px;
            }

            .evaluacion-item {
                flex-direction: column;
                align-items: flex-start;
                gap: 12px;
            }

            .estado-container {
                align-self: flex-end;
            }

            .button-container {
                flex-direction: column;
            }

            .btn {
                min-width: 100%;
            }
        }

        @media (max-width: 320px) {
            .header h1 {
                font-size: 1.1rem;
            }

            .estado-slider {
                width: 70px;
                height: 28px;
            }

            .estado-thumb {
                width: 24px;
                height: 24px;
                left: 23px;
            }

            .estado-thumb.no-realizado {
                left: 2px;
            }

            .estado-thumb.realizado {
                left: 44px;
            }
        }

        /* Estilo para el círculo de información de desarrolladores */
        .dev-info-circle {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: linear-gradient(135deg, #20b2aa, #40e0d0);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(32, 178, 170, 0.3);
            transition: all 0.3s ease;
            z-index: 1000;
        }

        .dev-info-circle:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 16px rgba(32, 178, 170, 0.4);
        }

        .dev-info-circle img {
            width: 30px;
            height: 30px;
            border-radius: 50%;
        }

        /* Modal para información de desarrolladores */
        .dev-info-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(0, 0, 0, 0.6);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            backdrop-filter: blur(3px);
        }

        .dev-info-content {
            background: white;
            border-radius: 12px;
            padding: 24px;
            max-width: 400px;
            width: 90%;
            text-align: center;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.2);
            animation: modalShow 0.3s ease-out;
            position: relative;
        }

        .dev-info-header {
            color: #20b2aa;
            font-size: 1.2rem;
            font-weight: 600;
            margin-bottom: 16px;
        }

        .dev-info-text {
            color: #2c5454;
            line-height: 1.6;
            margin-bottom: 8px;
        }

        .dev-info-link {
            color: #20b2aa;
            text-decoration: none;
            font-weight: 500;
        }

        .dev-info-link:hover {
            text-decoration: underline;
        }

        .dev-info-close {
            position: absolute;
            top: 10px;
            right: 15px;
            background: none;
            border: none;
            font-size: 24px;
            color: #666;
            cursor: pointer;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .dev-info-close:hover {
            color: #20b2aa;
        }

        @keyframes modalShow {
            from {
                opacity: 0;
                transform: scale(0.8);
            }

            to {
                opacity: 1;
                transform: scale(1);
            }
        }
    </style>
</head>

<body>
    <div class="container">
        <div class="header">
            <h1>Cumplimiento del Protocolo de Atención Médica para Niños, Niñas y Adolescentes con Síndrome de Down</h1>
            <p>Formulario de Cumplimiento del Protocolo</p>
            <div class="disclaimer">
                * Este protocolo se debe seguir en el individuo asintomático, para cumplir su objetivo preventivo.
                Cuando las pruebas de tamizaje (incluyendo hallazgos de la evaluación médica) sean anormales, la
                frecuencia de los controles y pruebas o consultas adicionales serán determinadas por el especialista.
            </div>
        </div>

        <!-- Loading state -->
        <div class="loading-container" id="loading-container">
            <div class="loading-spinner"></div>
            <span>Cargando datos del protocolo...</span>
        </div>

        <!-- Error state -->
        <div class="error-container" id="error-container" style="display: none;">
            <div class="error-message" id="error-message">Error al cargar los datos del protocolo</div>
            <button class="retry-button" onclick="cargarDatos()">Reintentar</button>
        </div>

        <div class="form-container" id="form-container" style="display: none;">
            <!-- Información del rango etario -->
            <div class="rango-etario-info">
                <div class="rango-etario-label">Rango etario:</div>
                <div class="rango-etario-valor" id="rango-etario-valor">-</div>
                <div class="edad-detalle" id="edad-detalle">-</div>
            </div>

            <!-- Indicadores de cumplimiento -->
            <div class="cumplimiento-container" id="cumplimiento-container">
                <div class="cumplimiento-item">
                    <span class="cumplimiento-label">Cumplimiento Puntual</span>
                    <div class="cumplimiento-porcentaje" id="cumplimiento-puntual">0%</div>
                    <div class="cumplimiento-descripcion">Procedimientos indicados para la edad actual realizados</div>
                </div>
                <div class="cumplimiento-item">
                    <span class="cumplimiento-label">Cumplimiento Global</span>
                    <div class="cumplimiento-porcentaje" id="cumplimiento-global">0%</div>
                    <div class="cumplimiento-descripcion">Exámenes obligatorios realizados del total que debería haberse
                        hecho</div>
                </div>
            </div>

            <div class="evaluaciones-container" id="evaluaciones-container">
                <!-- El cuestionario se generará aquí automáticamente -->
            </div>

            <div class="button-container">
                <button type="button" class="btn btn-secondary" id="btn-volver">Nueva Atención</button>
                <button type="button" class="btn btn-primary" id="btn-generar-informe">Guardar y Crear Informe</button>
            </div>
        </div>
    </div>

    <!-- Círculo de información de desarrolladores -->
    <div class="dev-info-circle" id="dev-info-circle">
        <img src="../favicon.png" alt="Co" />
    </div>

    <!-- Modal de información de desarrolladores -->
    <div class="dev-info-modal" id="dev-info-modal">
        <div class="dev-info-content">
            <button class="dev-info-close" id="dev-info-close">&times;</button>
            <div class="dev-info-header">Creado con cariño por:</div>
            <div class="dev-info-text">Dr. Víctor Mora, Médico Pediatra</div>
            <div class="dev-info-text">Dr. Fabio Cotes, Médico de hemodiálisis</div>
            <div class="dev-info-text">
                <a href="#" id="complemento-link" class="dev-info-link">Complemento</a>
            </div>
        </div>
    </div>

    <script>
        // Variables globales
        let edadPaciente = {
            años: 0,
            meses: 0
        };

        let datosSeguimiento = null;
        let nombresEvaluaciones = {};
        let evaluacionesData = {};
        let focusedSlider = null;
        let rangoEtarioActual = null;

        // Estados de evaluación
        const estados = {
            0: { clase: 'no-realizado', texto: 'No realizado' },
            1: { clase: 'no-disponible', texto: 'No disponible' },
            2: { clase: 'realizado', texto: 'Realizado' }
        };

        document.addEventListener('DOMContentLoaded', function () {
            // Leer edad desde registroIdentificacion si existe
            let registroIdentificacion = null;
            try {
                registroIdentificacion = JSON.parse(sessionStorage.getItem('registroIdentificacion'));
            } catch (e) { }
            if (registroIdentificacion && registroIdentificacion.paciente && registroIdentificacion.paciente.edadActual) {
                edadPaciente = {
                    años: registroIdentificacion.paciente.edadActual.años || 0,
                    meses: registroIdentificacion.paciente.edadActual.meses || 0
                };
            } else {
                // Mostrar error y detener el flujo
                mostrarEstado('error');
                mostrarError('No se pudo establecer la edad del paciente. Por favor complete primero el formulario de identificación.');
                return;
            }

            // Leer registro rescatado desde sessionStorage si existe
            let registroRescatado = null;
            try {
                registroRescatado = JSON.parse(sessionStorage.getItem('registroRescatado'));
            } catch (e) { }

            // Verificar si hay estados de evaluación cargados desde formulario de identificación
            let estadosEvaluacionCargados = null;
            try {
                estadosEvaluacionCargados = JSON.parse(sessionStorage.getItem('estadosEvaluacionCargados'));
            } catch (e) { }

            // Inicializar evaluacionesData con estados cargados si existen
            if (estadosEvaluacionCargados) {
                evaluacionesData = { ...estadosEvaluacionCargados };
                console.log('Estados de evaluación cargados desde registro:', evaluacionesData);
                sessionStorage.removeItem('estadosEvaluacionCargados'); // Limpiar después de usar
            } else if (registroRescatado && registroRescatado.evaluaciones && registroRescatado.evaluaciones.estadoActual) {
                evaluacionesData = { ...registroRescatado.evaluaciones.estadoActual };
                console.log('Estados de evaluación cargados desde registro rescatado:', evaluacionesData);
            }

            cargarDatos();
        });

        async function cargarDatos() {
            console.log('Iniciando carga de datos...');
            // Mostrar loading
            mostrarEstado('loading');

            try {
                // Usar la función expuesta por preload.js para leer variables.json desde la raíz de la app
                // Se pasa el nombre del archivo para que preload.js lo resuelva de forma portable
                const data = await window.api.leerVariablesJSON('variables.json');
                console.log('Datos cargados exitosamente:', data);

                // Asignar los datos cargados
                datosSeguimiento = data.datosSeguimiento || data;
                nombresEvaluaciones = data.nombresEvaluaciones || {};

                // Validar que los datos necesarios estén presentes
                if (!datosSeguimiento || !datosSeguimiento.escala_edad || !datosSeguimiento.intervenciones) {
                    throw new Error('Los datos cargados no tienen la estructura esperada');
                }

                console.log('Datos asignados correctamente');

                // Si existe registro rescatado, sobreescribir evaluacionesData
                if (window.registroRescatado && window.registroRescatado.evaluaciones) {
                    evaluacionesData = { ...window.registroRescatado.evaluaciones };
                }

                // Inicializar la aplicación
                await initializeApp();

                // Mostrar el formulario
                mostrarEstado('form');

            } catch (error) {
                console.error('Error al cargar datos:', error);
                mostrarError(`Error al cargar los datos del protocolo: ${error.message}`);
            }
        }

        function mostrarEstado(estado) {
            const loading = document.getElementById('loading-container');
            const error = document.getElementById('error-container');
            const form = document.getElementById('form-container');

            // Ocultar todos
            loading.style.display = 'none';
            error.style.display = 'none';
            form.style.display = 'none';

            // Mostrar el estado correspondiente
            switch (estado) {
                case 'loading':
                    loading.style.display = 'flex';
                    break;
                case 'error':
                    error.style.display = 'block';
                    break;
                case 'form':
                    form.style.display = 'block';
                    break;
            }
        }

        function mostrarError(mensaje) {
            document.getElementById('error-message').textContent = mensaje;
            mostrarEstado('error');
        }

        async function initializeApp() {
            console.log('Inicializando aplicación...');
            console.log('Edad del paciente:', edadPaciente);

            // Determinar rango etario basado en la edad del paciente
            rangoEtarioActual = determinarRangoEtario(edadPaciente);
            console.log('Rango etario determinado:', rangoEtarioActual);

            if (rangoEtarioActual) {
                // Mostrar información del rango etario
                mostrarRangoEtario(rangoEtarioActual);

                // Construir el cuestionario automáticamente (con lógica de atrasadas y vencidas)
                construirCuestionarioExtendido(rangoEtarioActual.codigo);
                // Aplicar estados de evaluación cargados justo después de construir el cuestionario
                setTimeout(() => {
                    aplicarEstadosEvaluacionCargados();
                }, 0);

                // Enfocar el primer slider de Evaluaciones Indicadas
                setTimeout(() => {
                    // Buscar específicamente en la sección de evaluaciones obligatorias (Evaluaciones Indicadas)
                    const seccionObligatoria = document.querySelector('.evaluacion-section[data-tipo="obligatorias"]');
                    if (seccionObligatoria) {
                        const primerSlider = seccionObligatoria.querySelector('.estado-slider[data-evaluacion]');
                        if (primerSlider) {
                            primerSlider.focus();
                            console.log('Focus establecido en el primer slider de Evaluaciones Indicadas');
                        }
                    }
                }, 200);

                // Calcular cumplimiento inicial
                calcularCumplimiento(rangoEtarioActual.codigo);
            } else {
                throw new Error('No se pudo determinar el rango etario');
            }

            configurarEventos();
            configurarNavegacionTeclado();

            // Configurar navegación Tab inteligente entre secciones
            setTimeout(() => {
                configurarNavegacionTabInteligente();
            }, 300);

            // Configurar comportamiento del botón "Guardar y Crear Informe" para que Tab se quede ahí
            setTimeout(() => {
                const informeBtn = document.getElementById('btn-generar-informe');
                if (informeBtn) {
                    informeBtn.addEventListener('keydown', function (e) {
                        if (e.key === 'Tab' && !e.shiftKey) {
                            // Prevenir que Tab vaya al siguiente elemento (volvería al inicio)
                            e.preventDefault();
                            // Mantener el focus en el mismo botón
                            informeBtn.focus();
                        }
                    });
                }
            }, 350);

            // Configurar funcionalidad del círculo de información de desarrolladores
            setTimeout(() => {
                const devCircle = document.getElementById('dev-info-circle');
                const devModal = document.getElementById('dev-info-modal');
                const devClose = document.getElementById('dev-info-close');
                const complementoLink = document.getElementById('complemento-link');

                devCircle.addEventListener('click', function () {
                    devModal.style.display = 'flex';
                });

                devClose.addEventListener('click', function () {
                    devModal.style.display = 'none';
                });

                // Cerrar modal al hacer clic fuera del contenido
                devModal.addEventListener('click', function (e) {
                    if (e.target === devModal) {
                        devModal.style.display = 'none';
                    }
                });

                // Cerrar modal con tecla Escape
                document.addEventListener('keydown', function (e) {
                    if (e.key === 'Escape' && devModal.style.display === 'flex') {
                        devModal.style.display = 'none';
                    }
                });

                // Abrir enlace en navegador externo
                complementoLink.addEventListener('click', function (e) {
                    e.preventDefault();
                    if (window.electronAPI && window.electronAPI.openExternal) {
                        window.electronAPI.openExternal('https://fabiocotes.md');
                    } else {
                        // Fallback si no está disponible la API
                        window.open('https://fabiocotes.md', '_blank');
                    }
                });
            }, 400);
        }

        function determinarRangoEtario(edad) {
            console.log('Determinando rango etario para edad:', edad);

            // Convertir edad a meses totales
            const mesesTotales = (edad.años * 12) + edad.meses;
            console.log('Meses totales:', mesesTotales);

            // Buscar el rango etario correspondiente
            for (let i = 0; i < datosSeguimiento.escala_edad.length; i++) {
                const rango = datosSeguimiento.escala_edad[i];

                // Lógica especial para recién nacido (primer mes)
                if (mesesTotales === 0 && rango.codigo === 1) {
                    console.log('Rango encontrado (RN):', rango);
                    return rango;
                }

                // Para el resto de rangos, verificar si está en el rango [código, código + 11]
                if (mesesTotales >= rango.codigo && mesesTotales <= rango.codigo + 11) {
                    console.log(`Rango encontrado: ${rango.etiqueta} (${rango.codigo}-${rango.codigo + 11} meses)`, rango);
                    return rango;
                }
            }

            // Si es mayor que todos los rangos, devolver el último
            const ultimoRango = datosSeguimiento.escala_edad[datosSeguimiento.escala_edad.length - 1];
            console.log('Usando último rango disponible:', ultimoRango);
            return ultimoRango;
        }

        function mostrarRangoEtario(rango) {
            console.log('Mostrando rango etario:', rango);

            const valorElement = document.getElementById('rango-etario-valor');
            const detalleElement = document.getElementById('edad-detalle');

            if (valorElement && detalleElement) {
                valorElement.textContent = rango.etiqueta;

                // Mostrar edad específica del paciente
                let edadTexto = '';
                if (edadPaciente.años > 0) {
                    edadTexto += `${edadPaciente.años} año${edadPaciente.años !== 1 ? 's' : ''}`;
                    if (edadPaciente.meses > 0) {
                        edadTexto += ` y ${edadPaciente.meses} mes${edadPaciente.meses !== 1 ? 'es' : ''}`;
                    }
                } else {
                    edadTexto = `${edadPaciente.meses} mes${edadPaciente.meses !== 1 ? 'es' : ''}`;
                }

                detalleElement.textContent = `Edad actual: ${edadTexto}`;
                console.log('Información del rango mostrada correctamente');
            } else {
                console.error('No se encontraron los elementos del DOM para mostrar el rango etario');
            }
        }

        function configurarEventos() {
            console.log('Configurando eventos...');

            // Eventos de botones
            document.getElementById('btn-volver').addEventListener('click', function () {
                console.log('Botón Nueva Atención clickeado - Reiniciando aplicación');

                // Limpiar todos los datos de sesión
                sessionStorage.clear();
                localStorage.clear();

                // Limpiar variables globales relacionadas con el registro
                if (window.registroOrigenPath) {
                    delete window.registroOrigenPath;
                }
                if (window.resultadosBusqueda) {
                    delete window.resultadosBusqueda;
                }

                // Redirigir al formulario de identificación limpio
                window.location.href = 'formulario_identificacion.html';
            });

            document.getElementById('btn-generar-informe').addEventListener('click', async function () {
                console.log('Botón Guardar y Crear Informe clickeado');

                // Primero guardar la evaluación
                const guardadoExitoso = await guardarEvaluacion();
                if (!guardadoExitoso) {
                    console.error('Error al guardar la evaluación, no se generará el informe');
                    return;
                }

                try {
                    // Preparar datos completos para el nuevo informe
                    await prepararDatosParaNuevoInforme();

                    // Abrir nuevo informe en ventana separada
                    await window.registroAPI.abrirNuevoInforme();
                } catch (error) {
                    console.error('Error al generar informe:', error);
                    alert('Error al generar el informe. Por favor, asegúrese de haber guardado los datos correctamente.');
                }
            });
        }

        function calcularCumplimiento(codigoActual) {
            console.log('Calculando cumplimiento para código:', codigoActual);

            // Cumplimiento Puntual: porcentaje de procedimientos indicados para la edad actual realizados
            const rangoActual = datosSeguimiento.escala_edad.find(r => r.codigo === codigoActual);
            if (!rangoActual) {
                console.error('No se encontró el rango actual');
                return;
            }

            const evaluacionesIndicadas = rangoActual.evaluacion_obligatoria;
            const evaluacionesIndicadasRealizadas = evaluacionesIndicadas.filter(eval =>
                evaluacionesData[eval] === 2
            ).length;

            const cumplimientoPuntual = evaluacionesIndicadas.length > 0 ?
                Math.round((evaluacionesIndicadasRealizadas / evaluacionesIndicadas.length) * 100) : 0;

            // Cumplimiento Global: porcentaje de exámenes obligatorios realizados del total que debería haberse hecho
            let totalObligatoriosAcumulados = new Set();
            let totalRealizadosAcumulados = 0;

            // Obtener todas las evaluaciones obligatorias hasta la edad actual
            datosSeguimiento.escala_edad.forEach(rango => {
                if (rango.codigo <= codigoActual) {
                    rango.evaluacion_obligatoria.forEach(eval => {
                        totalObligatoriosAcumulados.add(eval);
                    });
                }
            });

            // Contar cuántas de estas están realizadas
            totalObligatoriosAcumulados.forEach(eval => {
                if (evaluacionesData[eval] === 2) {
                    totalRealizadosAcumulados++;
                }
            });

            const cumplimientoGlobal = totalObligatoriosAcumulados.size > 0 ?
                Math.round((totalRealizadosAcumulados / totalObligatoriosAcumulados.size) * 100) : 0;

            console.log('Cumplimiento puntual:', cumplimientoPuntual + '%');
            console.log('Cumplimiento global:', cumplimientoGlobal + '%');

            // Actualizar indicadores
            const elementoPuntual = document.getElementById('cumplimiento-puntual');
            const elementoGlobal = document.getElementById('cumplimiento-global');

            if (elementoPuntual && elementoGlobal) {
                elementoPuntual.textContent = cumplimientoPuntual + '%';
                elementoGlobal.textContent = cumplimientoGlobal + '%';

                // Cambiar color según el porcentaje
                elementoPuntual.style.color = getColorPorcentaje(cumplimientoPuntual);
                elementoGlobal.style.color = getColorPorcentaje(cumplimientoGlobal);
            }
        }

        function getColorPorcentaje(porcentaje) {
            if (porcentaje >= 80) return '#4caf50'; // Verde
            if (porcentaje >= 60) return '#ff9800'; // Naranja
            return '#f44336'; // Rojo
        }

        function construirCuestionario(codigo) {
            console.log('Construyendo cuestionario para código:', codigo);

            const rango = datosSeguimiento.escala_edad.find(r => r.codigo === codigo);
            if (!rango) {
                console.error('No se encontró el rango para el código:', codigo);
                return;
            }

            const container = document.getElementById('evaluaciones-container');
            if (!container) {
                console.error('No se encontró el contenedor de evaluaciones');
                return;
            }

            container.innerHTML = '';

            // Crear sección de evaluaciones obligatorias (siempre desplegada)
            if (rango.evaluacion_obligatoria.length > 0) {
                console.log('Creando sección de evaluaciones obligatorias');
                const seccionObligatoria = crearSeccionEvaluacion(
                    'Evaluaciones Indicadas',
                    rango.evaluacion_obligatoria,
                    false, // No colapsada
                    'obligatorias'
                );
                container.appendChild(seccionObligatoria);
            }

            // Crear sección de evaluaciones opcionales (colapsada por defecto)
            if (rango.evaluacion_opcional.length > 0) {
                console.log('Creando sección de evaluaciones opcionales');
                const seccionOpcional = crearSeccionEvaluacion(
                    'Evaluaciones Opcionales',
                    rango.evaluacion_opcional,
                    true, // Colapsada
                    'opcionales'
                );
                container.appendChild(seccionOpcional);
            }

            console.log('Cuestionario construido correctamente');
        }

        function crearSeccionEvaluacion(titulo, evaluaciones, colapsada, tipo) {
            console.log('Creando sección:', titulo, 'con', evaluaciones.length, 'evaluaciones');

            const section = document.createElement('div');
            section.className = 'evaluacion-group evaluacion-section';
            if (tipo) {
                section.setAttribute('data-tipo', tipo);
            }

            const header = document.createElement('div');
            header.className = `evaluacion-header ${colapsada ? 'collapsed' : ''}`;
            header.innerHTML = `
                <span>${titulo}</span>
                <span class="collapse-icon ${colapsada ? 'rotated' : ''}">▼</span>
            `;

            const content = document.createElement('div');
            content.className = `evaluacion-content ${colapsada ? 'collapsed' : ''}`;

            evaluaciones.forEach(evaluacionKey => {
                const item = crearItemEvaluacion(evaluacionKey);
                content.appendChild(item);
            });

            header.addEventListener('click', function () {
                toggleSection(header, content);
            });

            section.appendChild(header);
            section.appendChild(content);

            return section;
        }

        function crearItemEvaluacion(evaluacionKey) {
            console.log('Creando item para evaluación:', evaluacionKey);

            const item = document.createElement('div');
            item.className = 'evaluacion-item';

            const nombre = document.createElement('div');
            nombre.className = 'evaluacion-name';
            nombre.textContent = nombresEvaluaciones[evaluacionKey] || evaluacionKey;

            const estadoContainer = document.createElement('div');
            estadoContainer.className = 'estado-container';

            const slider = document.createElement('div');
            slider.className = 'estado-slider';
            slider.tabIndex = 0;
            slider.setAttribute('data-evaluacion', evaluacionKey);

            const thumb = document.createElement('div');
            thumb.className = 'estado-thumb no-disponible';

            const label = document.createElement('div');
            label.className = 'estado-label no-disponible';
            label.textContent = 'No disponible';

            slider.appendChild(thumb);
            estadoContainer.appendChild(slider);
            estadoContainer.appendChild(label);

            item.appendChild(nombre);
            item.appendChild(estadoContainer);

            // Inicializar estado - verificar si ya existe o usar por defecto
            if (evaluacionesData[evaluacionKey] === undefined) {
                evaluacionesData[evaluacionKey] = 1; // No disponible por defecto
            }

            // Aplicar estado inicial cargado si existe
            const estadoInicial = evaluacionesData[evaluacionKey];
            const estadoInfo = estados[estadoInicial];
            thumb.className = `estado-thumb ${estadoInfo.clase}`;
            label.className = `estado-label ${estadoInfo.clase}`;
            label.textContent = estadoInfo.texto;

            // Eventos del slider
            slider.addEventListener('click', function (e) {
                const rect = slider.getBoundingClientRect();
                const x = e.clientX - rect.left;
                const width = rect.width;
                let nuevoEstado;

                if (x < width / 3) {
                    nuevoEstado = 0; // No realizado
                } else if (x < (2 * width) / 3) {
                    nuevoEstado = 1; // No disponible
                } else {
                    nuevoEstado = 2; // Realizado
                }

                actualizarEstado(evaluacionKey, nuevoEstado, thumb, label);
            });

            slider.addEventListener('focus', function () {
                focusedSlider = evaluacionKey;
            });

            slider.addEventListener('blur', function () {
                focusedSlider = null;
            });

            return item;
        }

        function toggleSection(header, content) {
            const isCollapsed = content.classList.contains('collapsed');
            if (isCollapsed) {
                // Cerrar todas las secciones
                document.querySelectorAll('.evaluacion-content').forEach(c => c.classList.add('collapsed'));
                document.querySelectorAll('.evaluacion-header').forEach(h => {
                    h.classList.add('collapsed');
                    const icon = h.querySelector('.collapse-icon');
                    if (icon) icon.classList.add('rotated');
                });
                // Abrir solo la seleccionada
                content.classList.remove('collapsed');
                header.classList.remove('collapsed');
                header.querySelector('.collapse-icon').classList.remove('rotated');
            } else {
                content.classList.add('collapsed');
                header.classList.add('collapsed');
                header.querySelector('.collapse-icon').classList.add('rotated');
            }
        }

        function actualizarEstado(evaluacionKey, estado, thumb, label) {
            console.log('Actualizando estado de', evaluacionKey, 'a', estado);

            evaluacionesData[evaluacionKey] = estado;
            const estadoInfo = estados[estado];

            thumb.className = `estado-thumb ${estadoInfo.clase}`;
            label.className = `estado-label ${estadoInfo.clase}`;
            label.textContent = estadoInfo.texto;

            // Recalcular cumplimiento cuando cambie un estado
            if (rangoEtarioActual) {
                calcularCumplimiento(rangoEtarioActual.codigo);
            }
        }

        function configurarNavegacionTeclado() {
            document.addEventListener('keydown', function (e) {
                if (!focusedSlider) return;

                const currentState = evaluacionesData[focusedSlider];
                let newState = currentState;

                switch (e.key) {
                    case 'ArrowLeft':
                        e.preventDefault();
                        newState = Math.max(0, currentState - 1);
                        break;
                    case 'ArrowRight':
                        e.preventDefault();
                        newState = Math.min(2, currentState + 1);
                        break;
                    case 'Tab':
                        // Permitir navegación normal con Tab
                        return;
                    default:
                        return;
                }

                if (newState !== currentState) {
                    const slider = document.querySelector(`[data-evaluacion="${focusedSlider}"]`);
                    const thumb = slider.querySelector('.estado-thumb');
                    const label = slider.parentElement.querySelector('.estado-label');

                    actualizarEstado(focusedSlider, newState, thumb, label);
                }
            });
        }

        // Funciones auxiliares para navegación Tab inteligente en formulario cumplimiento
        function obtenerSeccionesEvaluacion() {
            return Array.from(document.querySelectorAll('.evaluacion-group')).filter(section => {
                // Solo incluir secciones que tengan sliders de estado
                return section.querySelector('.estado-slider[data-evaluacion]') !== null;
            });
        }

        function obtenerUltimoSliderEnSeccion(seccion) {
            const sliders = seccion.querySelectorAll('.estado-slider[data-evaluacion]');
            return sliders.length > 0 ? sliders[sliders.length - 1] : null;
        }

        function obtenerPrimerSliderEnSeccion(seccion) {
            return seccion.querySelector('.estado-slider[data-evaluacion]');
        }

        function obtenerSiguienteSeccion(seccionActual, secciones) {
            const indiceActual = secciones.indexOf(seccionActual);
            return indiceActual < secciones.length - 1 ? secciones[indiceActual + 1] : null;
        }

        function abrirSeccion(seccion) {
            const header = seccion.querySelector('.evaluacion-header');
            const content = seccion.querySelector('.evaluacion-content');

            if (header && content && content.classList.contains('collapsed')) {
                // Cerrar todas las secciones primero
                document.querySelectorAll('.evaluacion-content').forEach(c => c.classList.add('collapsed'));
                document.querySelectorAll('.evaluacion-header').forEach(h => {
                    h.classList.add('collapsed');
                    const icon = h.querySelector('.collapse-icon');
                    if (icon) icon.classList.add('rotated');
                });

                // Abrir la sección específica
                content.classList.remove('collapsed');
                header.classList.remove('collapsed');
                const icon = header.querySelector('.collapse-icon');
                if (icon) icon.classList.remove('rotated');
            }
        }

        function configurarNavegacionTabInteligente() {
            console.log('Configurando navegación Tab inteligente para formulario cumplimiento');

            const secciones = obtenerSeccionesEvaluacion();
            console.log('Secciones de evaluación encontradas:', secciones.length);

            secciones.forEach((seccion, index) => {
                const ultimoSlider = obtenerUltimoSliderEnSeccion(seccion);
                if (!ultimoSlider) return;

                ultimoSlider.addEventListener('keydown', function (e) {
                    if (e.key === 'Tab' && !e.shiftKey) {
                        const siguienteSeccion = obtenerSiguienteSeccion(seccion, secciones);
                        if (siguienteSeccion) {
                            e.preventDefault();

                            // Abrir la siguiente sección
                            abrirSeccion(siguienteSeccion);

                            // Enfocar el primer slider de la siguiente sección
                            setTimeout(() => {
                                const primerSlider = obtenerPrimerSliderEnSeccion(siguienteSeccion);
                                if (primerSlider) {
                                    primerSlider.focus();
                                    console.log('Focus establecido en primer slider de siguiente sección');
                                }
                            }, 150);
                        } else {
                            // Si es la última sección, ir al botón Guardar y Crear Informe
                            e.preventDefault();
                            const informeBtn = document.getElementById('btn-generar-informe');
                            if (informeBtn) {
                                informeBtn.focus();
                                console.log('Focus establecido en botón Guardar y Crear Informe');
                            }
                        }
                    }
                });
            });
        }

        async function guardarEvaluacion() {
            if (!rangoEtarioActual) {
                alert('Error: No se ha determinado el rango etario');
                return false;
            }

            // Obtener datos de identificación desde sessionStorage (formulario_identificacion)
            let datosIdentificacion = null;
            try {
                datosIdentificacion = JSON.parse(sessionStorage.getItem('registroIdentificacion'));
            } catch (e) { }
            if (!datosIdentificacion) {
                alert('No se encontró información de identificación del paciente. Complete el formulario de identificación.');
                return false;
            }

            // Preparar objeto completo para guardar
            const fechaActual = new Date().toISOString();
            let registroRescatado = null;
            let codigoRegistro = null;
            let archivoDestino = null;
            let esActualizacion = false;

            try {
                registroRescatado = JSON.parse(sessionStorage.getItem('registroRescatado'));
            } catch (e) { }

            if (registroRescatado && registroRescatado.codigoRegistro) {
                // Actualizar registro existente
                codigoRegistro = registroRescatado.codigoRegistro;
                let nombreBase = `registro-${codigoRegistro}.json`;
                archivoDestino = nombreBase;
                esActualizacion = true;
            } else {
                // Buscar nombre de archivo en sessionStorage generado por identificación
                let nombreArchivoIdentificacion = null;
                try {
                    nombreArchivoIdentificacion = sessionStorage.getItem('registroArchivo');
                } catch (e) { }
                if (nombreArchivoIdentificacion) {
                    archivoDestino = nombreArchivoIdentificacion;
                    // Extraer UUID del nombre
                    const match = nombreArchivoIdentificacion.match(/registro-(.*)\.json/);
                    codigoRegistro = match ? match[1] : null;
                } else {
                    if (window.api && window.api.generarUUID) {
                        codigoRegistro = window.api.generarUUID();
                    } else {
                        codigoRegistro = 'r' + Date.now();
                    }
                    archivoDestino = `registro-${codigoRegistro}.json`;
                }
            }

            // Leer el archivo existente si existe
            let registroExistente = null;
            if (archivoDestino && window.api && window.api.leerRegistroJSON) {
                try {
                    registroExistente = await window.api.leerRegistroJSON(archivoDestino);
                    console.log('Registro existente cargado:', registroExistente);
                } catch (e) {
                    console.log('No se pudo cargar registro existente, usando datos de sessionStorage:', e);
                    registroExistente = registroRescatado;
                }
            }

            // Construir el registro final conservando los campos existentes
            const registroCompleto = {
                ...(registroExistente || {}),
                metadata: {
                    ...(registroExistente?.metadata || {}),
                    version: '1.0.0',
                    lastModified: fechaActual,
                    application: 'Protocolo Síndrome de Down - Electron App',
                    description: 'Registro de cumplimiento del protocolo de atención médica para niños, niñas y adolescentes con síndrome de Down'
                },
                codigoRegistro: codigoRegistro,
                paciente: datosIdentificacion.paciente,
                acudiente: datosIdentificacion.acudiente,
                protocolo: datosIdentificacion.protocolo,
                rangoEtario: rangoEtarioActual,
                evaluaciones: {
                    estadoActual: { ...evaluacionesData },
                    resumen: generarResumen(),
                    fechaEvaluacion: fechaActual
                },
                cumplimiento: calcularCumplimientoJSON(),
                historial: Array.isArray(registroExistente?.historial) ? [...registroExistente.historial] : [],
                configuracion: registroExistente?.configuracion || {},
                auditoria: {
                    ...(registroExistente?.auditoria || {}),
                    creadoPor: datosIdentificacion?.usuario || 'sistema',
                    fechaCreacion: registroExistente?.auditoria?.fechaCreacion || fechaActual,
                    ultimaModificacionPor: datosIdentificacion?.usuario || 'sistema',
                    fechaUltimaModificacion: fechaActual,
                    versionRegistro: registroExistente?.auditoria?.versionRegistro ? (registroExistente.auditoria.versionRegistro + 1) : 1,
                    checksum: ''
                }
            };

            // Actualizar historial
            registroCompleto.historial.push({
                fecha: fechaActual,
                accion: esActualizacion ? 'actualizacion_registro' : 'creacion_registro',
                usuario: datosIdentificacion?.usuario || 'sistema',
                detalles: esActualizacion ? 'Registro actualizado' : 'Registro creado'
            });

            // Guardar en archivo usando la API de Electron
            const rutaCompleta = `registros/${archivoDestino}`;

            // Usar siempre la función guardar-registro que ahora maneja tanto creación como actualización
            console.log(registroExistente ? 'Actualizando registro existente:' : 'Creando nuevo registro:', archivoDestino);

            try {
                const resultado = await window.registroAPI.guardarRegistro(registroCompleto, archivoDestino);
                if (resultado.success) {
                    sessionStorage.setItem('registroRescatado', JSON.stringify(registroCompleto));
                    const mensaje = resultado.operacion === 'actualizado'
                        ? 'Registro actualizado correctamente.'
                        : 'Registro guardado correctamente.';
                    console.log(mensaje);
                    console.log(`Operación exitosa: ${resultado.operacion} en ${resultado.filePath}`);
                    return true;
                } else {
                    console.error('Error al guardar/actualizar:', resultado.error);
                    alert('Error al procesar el registro: ' + resultado.error);
                    return false;
                }
            } catch (error) {
                console.error('Error al procesar el registro:', error);
                alert('Error al procesar el registro en archivo.');
                return false;
            }
        }

        // Calcula el objeto de cumplimiento para el JSON
        function calcularCumplimientoJSON() {
            // Cumplimiento puntual y global
            const codigoActual = rangoEtarioActual.codigo;
            const rangoActual = datosSeguimiento.escala_edad.find(r => r.codigo === codigoActual);
            const evaluacionesIndicadas = rangoActual.evaluacion_obligatoria;
            const evaluacionesIndicadasRealizadas = evaluacionesIndicadas.filter(eval => evaluacionesData[eval] === 2).length;
            const cumplimientoPuntual = evaluacionesIndicadas.length > 0 ? Math.round((evaluacionesIndicadasRealizadas / evaluacionesIndicadas.length) * 100) : 0;

            let totalObligatoriosAcumulados = new Set();
            let totalRealizadosAcumulados = 0;
            datosSeguimiento.escala_edad.forEach(rango => {
                if (rango.codigo <= codigoActual) {
                    rango.evaluacion_obligatoria.forEach(eval => {
                        totalObligatoriosAcumulados.add(eval);
                    });
                }
            });
            totalObligatoriosAcumulados.forEach(eval => {
                if (evaluacionesData[eval] === 2) {
                    totalRealizadosAcumulados++;
                }
            });
            const cumplimientoGlobal = totalObligatoriosAcumulados.size > 0 ? Math.round((totalRealizadosAcumulados / totalObligatoriosAcumulados.size) * 100) : 0;

            return {
                puntual: {
                    porcentaje: cumplimientoPuntual,
                    evaluacionesIndicadas: evaluacionesIndicadas.length,
                    evaluacionesRealizadas: evaluacionesIndicadasRealizadas,
                    detalles: `${evaluacionesIndicadasRealizadas} de ${evaluacionesIndicadas.length} evaluaciones obligatorias para la edad actual realizadas`
                },
                global: {
                    porcentaje: cumplimientoGlobal,
                    totalObligatorias: totalObligatoriosAcumulados.size,
                    totalRealizadas: totalRealizadosAcumulados,
                    detalles: `${totalRealizadosAcumulados} de ${totalObligatoriosAcumulados.size} evaluaciones obligatorias acumuladas realizadas`
                },
                resumen: generarResumen()
            };
        }


        function generarResumen() {
            const conteos = { 0: 0, 1: 0, 2: 0 };

            Object.entries(evaluacionesData).forEach(([evaluacion, estado]) => {
                conteos[estado]++;
            });

            return {
                edadPaciente: edadPaciente,
                rangoEtario: rangoEtarioActual ? rangoEtarioActual.etiqueta : 'No determinado',
                totalEvaluaciones: Object.keys(evaluacionesData).length,
                noRealizadas: conteos[0],
                noDisponibles: conteos[1],
                realizadas: conteos[2],
                porcentajeCompletitud: Object.keys(evaluacionesData).length > 0 ?
                    Math.round((conteos[2] / Object.keys(evaluacionesData).length) * 100) : 0
            };
        }

        // Función para actualizar edad desde otra página (uso futuro)
        function actualizarEdadPaciente(nuevaEdad) {
            console.log('Actualizando edad del paciente a:', nuevaEdad);
            edadPaciente = nuevaEdad;

            if (datosSeguimiento) {
                rangoEtarioActual = determinarRangoEtario(edadPaciente);

                if (rangoEtarioActual) {
                    mostrarRangoEtario(rangoEtarioActual);
                    construirCuestionarioExtendido(rangoEtarioActual.codigo);
                    calcularCumplimiento(rangoEtarioActual.codigo);
                }
            }
        }

        // --- Lógica extendida para Evaluaciones Atrasadas y Vencidas ---
        function obtenerEvaluacionesVencidas(codigoActual) {
            const rangoActual = datosSeguimiento.escala_edad.find(r => r.codigo === codigoActual);
            if (!rangoActual || !rangoActual.evaluacion_no_indicada) return [];

            const evaluacionesVencidas = [];

            rangoActual.evaluacion_no_indicada.forEach(evaluacion => {
                const infoIntervencion = datosSeguimiento.intervenciones[evaluacion];
                if (infoIntervencion) {
                    // Buscar la edad más reciente donde era obligatoria u opcional y es menor que la actual
                    const edadesObligatorias = infoIntervencion.edad_obligatoria.filter(edad => edad < codigoActual);
                    const edadesOpcionales = infoIntervencion.edad_opcional ?
                        infoIntervencion.edad_opcional.filter(edad => edad < codigoActual) : [];
                    if (edadesObligatorias.length > 0 || edadesOpcionales.length > 0) {
                        const ultimaEdadObligatoria = edadesObligatorias.length > 0 ?
                            Math.max(...edadesObligatorias) : null;
                        const ultimaEdadOpcional = edadesOpcionales.length > 0 ?
                            Math.max(...edadesOpcionales) : null;
                        let ultimaEdad = null;
                        let tipo = '';
                        if (ultimaEdadObligatoria && ultimaEdadOpcional) {
                            if (ultimaEdadObligatoria > ultimaEdadOpcional) {
                                ultimaEdad = ultimaEdadObligatoria;
                                tipo = 'obligatoria';
                            } else {
                                ultimaEdad = ultimaEdadOpcional;
                                tipo = 'opcional';
                            }
                        } else if (ultimaEdadObligatoria) {
                            ultimaEdad = ultimaEdadObligatoria;
                            tipo = 'obligatoria';
                        } else if (ultimaEdadOpcional) {
                            ultimaEdad = ultimaEdadOpcional;
                            tipo = 'opcional';
                        }
                        if (ultimaEdad) {
                            const rangoAnterior = datosSeguimiento.escala_edad.find(r => r.codigo === ultimaEdad);
                            evaluacionesVencidas.push({
                                key: evaluacion,
                                ultimaEdad: ultimaEdad,
                                etiquetaEdad: rangoAnterior ? rangoAnterior.etiqueta : ultimaEdad + ' meses',
                                tipo: tipo
                            });
                        }
                    }
                }
            });
            return evaluacionesVencidas.sort((a, b) => b.ultimaEdad - a.ultimaEdad);
        }

        function obtenerEvaluacionesAtrasadas(codigoActual) {
            const evaluacionesAtrasadas = [];
            const todasLasEvaluaciones = Object.keys(nombresEvaluaciones);
            const rangoActual = datosSeguimiento.escala_edad.find(r => r.codigo === codigoActual);
            if (!rangoActual) return [];
            const evaluacionesActuales = new Set([
                ...rangoActual.evaluacion_obligatoria,
                ...rangoActual.evaluacion_opcional,
                ...rangoActual.evaluacion_no_indicada
            ]);
            todasLasEvaluaciones.forEach(evaluacion => {
                if (!evaluacionesActuales.has(evaluacion)) {
                    const infoIntervencion = datosSeguimiento.intervenciones[evaluacion];
                    if (infoIntervencion) {
                        const edadesObligatorias = infoIntervencion.edad_obligatoria.filter(edad => edad < codigoActual);
                        const edadesOpcionales = infoIntervencion.edad_opcional ?
                            infoIntervencion.edad_opcional.filter(edad => edad < codigoActual) : [];
                        if (edadesObligatorias.length > 0 || edadesOpcionales.length > 0) {
                            const ultimaEdadObligatoria = edadesObligatorias.length > 0 ?
                                Math.max(...edadesObligatorias) : null;
                            const ultimaEdadOpcional = edadesOpcionales.length > 0 ?
                                Math.max(...edadesOpcionales) : null;
                            let ultimaEdad = null;
                            let tipo = '';
                            if (ultimaEdadObligatoria && ultimaEdadOpcional) {
                                if (ultimaEdadObligatoria > ultimaEdadOpcional) {
                                    ultimaEdad = ultimaEdadObligatoria;
                                    tipo = 'obligatoria';
                                } else {
                                    ultimaEdad = ultimaEdadOpcional;
                                    tipo = 'opcional';
                                }
                            } else if (ultimaEdadObligatoria) {
                                ultimaEdad = ultimaEdadObligatoria;
                                tipo = 'obligatoria';
                            } else if (ultimaEdadOpcional) {
                                ultimaEdad = ultimaEdadOpcional;
                                tipo = 'opcional';
                            }
                            if (ultimaEdad) {
                                const rangoAnterior = datosSeguimiento.escala_edad.find(r => r.codigo === ultimaEdad);
                                evaluacionesAtrasadas.push({
                                    key: evaluacion,
                                    ultimaEdad: ultimaEdad,
                                    etiquetaEdad: rangoAnterior ? rangoAnterior.etiqueta : ultimaEdad + ' meses',
                                    tipo: tipo
                                });
                            }
                        }
                    }
                }
            });
            return evaluacionesAtrasadas.sort((a, b) => b.ultimaEdad - a.ultimaEdad);
        }

        function construirCuestionarioExtendido(codigo) {
            const rango = datosSeguimiento.escala_edad.find(r => r.codigo === codigo);
            if (!rango) return;
            const container = document.getElementById('evaluaciones-container');
            container.innerHTML = '';
            // Sección obligatorias
            if (rango.evaluacion_obligatoria.length > 0) {
                const seccionObligatoria = crearSeccionEvaluacion(
                    'Evaluaciones Indicadas',
                    rango.evaluacion_obligatoria,
                    false,
                    'obligatorias'
                );
                container.appendChild(seccionObligatoria);
            }
            // Sección opcionales
            if (rango.evaluacion_opcional.length > 0) {
                const seccionOpcional = crearSeccionEvaluacion(
                    'Evaluaciones Opcionales',
                    rango.evaluacion_opcional,
                    true,
                    'opcionales'
                );
                container.appendChild(seccionOpcional);
            }
            // Sección atrasadas
            const evaluacionesAtrasadas = obtenerEvaluacionesAtrasadas(codigo);
            if (evaluacionesAtrasadas.length > 0) {
                const seccionAtrasadas = crearSeccionEvaluacionesAtrasadas(
                    'Evaluaciones Atrasadas',
                    evaluacionesAtrasadas,
                    true
                );
                container.appendChild(seccionAtrasadas);
            }
            // Sección vencidas
            const evaluacionesVencidas = obtenerEvaluacionesVencidas(codigo);
            if (evaluacionesVencidas.length > 0) {
                const seccionVencidas = crearSeccionEvaluacionesVencidas(
                    'Evaluaciones Vencidas',
                    evaluacionesVencidas,
                    true
                );
                container.appendChild(seccionVencidas);
            }

            // Sección Exámenes para la siguiente sesión
            const siguienteRango = obtenerSiguienteRangoEtario(codigo);
            if (siguienteRango) {
                const examenesSiguiente = obtenerExamenesSiguienteSesion(siguienteRango);
                if (examenesSiguiente.length > 0) {
                    const seccionSiguiente = crearSeccionExamenesSiguienteSesion(
                        'Exámenes para la siguiente sesión',
                        examenesSiguiente,
                        true
                    );
                    container.appendChild(seccionSiguiente);
                }
            }
        }
        // Devuelve el rango etario siguiente al actual
        function obtenerSiguienteRangoEtario(codigoActual) {
            const rangos = datosSeguimiento.escala_edad;
            const idx = rangos.findIndex(r => r.codigo === codigoActual);
            if (idx >= 0 && idx < rangos.length - 1) {
                return rangos[idx + 1];
            }
            return null;
        }

        // Devuelve los exámenes para la siguiente sesión según los criterios especificados
        function obtenerExamenesSiguienteSesion(rangoSiguiente) {
            const examenes = [];

            // Lógica corregida según especificaciones:
            // - Excluir Evaluaciones Indicadas con estado diferente a Realizado
            // - Excluir Evaluaciones Opcionales 
            // - Incluir Evaluaciones Atrasadas con estado diferente a Realizado
            // - Incluir evaluaciones_indicadas del siguiente grupo etario, marcando las ya realizadas

            // 1. Incluir evaluaciones_indicadas (obligatorias) del siguiente grupo etario
            if (rangoSiguiente.evaluacion_obligatoria) {
                rangoSiguiente.evaluacion_obligatoria.forEach(evaluacion => {
                    // Solo incluir si no está en evaluacion_no_indicada
                    if (!rangoSiguiente.evaluacion_no_indicada || !rangoSiguiente.evaluacion_no_indicada.includes(evaluacion)) {
                        const estadoActual = evaluacionesData[evaluacion] || 1; // Default: No disponible
                        const yaRealizado = estadoActual === 2; // Estado 2 = Realizado

                        examenes.push({
                            key: evaluacion,
                            tipo: 'obligatoria',
                            estado: estadoActual,
                            yaRealizado: yaRealizado,
                            categoria: 'siguiente_grupo'
                        });
                    }
                });
            }

            // 2. Incluir Evaluaciones Atrasadas con estado diferente a Realizado
            const evaluacionesAtrasadas = obtenerEvaluacionesAtrasadas(rangoSiguiente.codigo);
            evaluacionesAtrasadas.forEach(evaluacionInfo => {
                const estadoActual = evaluacionesData[evaluacionInfo.key] || 1;
                // Solo incluir si NO está realizado (estado diferente a 2)
                if (estadoActual !== 2) {
                    examenes.push({
                        key: evaluacionInfo.key,
                        tipo: evaluacionInfo.tipo,
                        estado: estadoActual,
                        yaRealizado: false,
                        categoria: 'atrasada',
                        etiquetaEdad: evaluacionInfo.etiquetaEdad
                    });
                }
            });

            // Eliminar duplicados (una evaluación podría aparecer tanto en obligatorias como en atrasadas)
            const examenesUnicos = [];
            const evaluacionesVistas = new Set();

            examenes.forEach(examen => {
                if (!evaluacionesVistas.has(examen.key)) {
                    evaluacionesVistas.add(examen.key);
                    examenesUnicos.push(examen);
                }
            });

            return examenesUnicos;
        }

        // Crea la sección visual de exámenes para la siguiente sesión
        function crearSeccionExamenesSiguienteSesion(titulo, examenes, colapsada) {
            const section = document.createElement('div');
            section.className = 'evaluacion-group';
            const header = document.createElement('div');
            header.className = `evaluacion-header ${colapsada ? 'collapsed' : ''}`;
            header.innerHTML = `
                <span>${titulo}</span>
                <span class="collapse-icon ${colapsada ? 'rotated' : ''}">▼</span>
            `;
            const content = document.createElement('div');
            content.className = `evaluacion-content ${colapsada ? 'collapsed' : ''}`;

            examenes.forEach(examenInfo => {
                const item = document.createElement('div');
                item.className = 'evaluacion-item';

                const nombre = document.createElement('div');
                nombre.className = 'evaluacion-name';

                // Nombre de la evaluación
                const nombreTexto = document.createElement('div');
                nombreTexto.textContent = nombresEvaluaciones[examenInfo.key] || examenInfo.key;
                nombre.appendChild(nombreTexto);

                // Información adicional basada en la categoría
                const infoAdicional = document.createElement('div');
                infoAdicional.style.fontSize = '0.8rem';
                infoAdicional.style.marginTop = '4px';

                if (examenInfo.categoria === 'atrasada') {
                    infoAdicional.className = 'edad-info';
                    infoAdicional.textContent = `Atrasada desde: ${examenInfo.etiquetaEdad}`;
                    infoAdicional.style.color = '#ff6b35';
                } else if (examenInfo.categoria === 'siguiente_grupo') {
                    infoAdicional.className = 'siguiente-grupo-info';
                    infoAdicional.textContent = 'Indicada para siguiente grupo etario';
                    infoAdicional.style.color = '#20b2aa';
                }

                nombre.appendChild(infoAdicional);

                // Contenedor de estado
                const estadoContainer = document.createElement('div');
                estadoContainer.className = 'estado-container';
                estadoContainer.style.display = 'flex';
                estadoContainer.style.alignItems = 'center';
                estadoContainer.style.gap = '12px';

                // Etiqueta de tipo y estado
                const estadoLabel = document.createElement('div');
                estadoLabel.style.display = 'flex';
                estadoLabel.style.flexDirection = 'column';
                estadoLabel.style.alignItems = 'flex-end';
                estadoLabel.style.fontSize = '0.8rem';

                const tipoLabel = document.createElement('span');
                tipoLabel.textContent = examenInfo.tipo === 'obligatoria' ? 'Obligatorio' : 'Opcional';
                tipoLabel.style.color = examenInfo.tipo === 'obligatoria' ? '#20b2aa' : '#888';
                tipoLabel.style.fontWeight = '500';

                const realizadoLabel = document.createElement('span');
                if (examenInfo.yaRealizado) {
                    realizadoLabel.textContent = '✓ Realizado';
                    realizadoLabel.style.color = '#4caf50';
                    realizadoLabel.style.fontWeight = '600';
                } else {
                    realizadoLabel.textContent = 'Pendiente';
                    realizadoLabel.style.color = '#ff9800';
                    realizadoLabel.style.fontStyle = 'italic';
                }

                estadoLabel.appendChild(tipoLabel);
                estadoLabel.appendChild(realizadoLabel);
                estadoContainer.appendChild(estadoLabel);

                item.appendChild(nombre);
                item.appendChild(estadoContainer);
                content.appendChild(item);
            });

            header.addEventListener('click', function () {
                toggleSection(header, content);
            });
            section.appendChild(header);
            section.appendChild(content);
            return section;
        }

        function crearSeccionEvaluacionesAtrasadas(titulo, evaluacionesAtrasadas, colapsada) {
            const section = document.createElement('div');
            section.className = 'evaluacion-group';
            const conteoAtrasadas = evaluacionesAtrasadas.length;
            const header = document.createElement('div');
            header.className = `evaluacion-header atrasadas ${colapsada ? 'collapsed' : ''}`;
            header.innerHTML = `
                <span>${titulo}<span class="atrasadas-badge">${conteoAtrasadas}</span></span>
                <span class="collapse-icon ${colapsada ? 'rotated' : ''}">▼</span>
            `;
            const content = document.createElement('div');
            content.className = `evaluacion-content ${colapsada ? 'collapsed' : ''}`;
            evaluacionesAtrasadas.forEach(evaluacionInfo => {
                const item = crearItemEvaluacionAtrasada(evaluacionInfo);
                content.appendChild(item);
            });
            header.addEventListener('click', function () {
                toggleSection(header, content);
            });
            section.appendChild(header);
            section.appendChild(content);
            return section;
        }

        function crearSeccionEvaluacionesVencidas(titulo, evaluacionesVencidas, colapsada) {
            const section = document.createElement('div');
            section.className = 'evaluacion-group';
            const conteoVencidas = evaluacionesVencidas.length;
            const header = document.createElement('div');
            header.className = `evaluacion-header vencidas ${colapsada ? 'collapsed' : ''}`;
            header.innerHTML = `
                <span>${titulo}<span class="vencidas-badge">${conteoVencidas}</span></span>
                <span class="collapse-icon ${colapsada ? 'rotated' : ''}">▼</span>
            `;
            const content = document.createElement('div');
            content.className = `evaluacion-content ${colapsada ? 'collapsed' : ''}`;
            evaluacionesVencidas.forEach(evaluacionInfo => {
                const item = crearItemEvaluacionVencida(evaluacionInfo);
                content.appendChild(item);
            });
            header.addEventListener('click', function () {
                toggleSection(header, content);
            });
            section.appendChild(header);
            section.appendChild(content);
            return section;
        }

        function crearItemEvaluacionAtrasada(evaluacionInfo) {
            const item = document.createElement('div');
            item.className = 'evaluacion-item';
            const nombre = document.createElement('div');
            nombre.className = 'evaluacion-name atrasada';
            const nombreTexto = document.createElement('div');
            nombreTexto.textContent = nombresEvaluaciones[evaluacionInfo.key] || evaluacionInfo.key;
            const edadInfo = document.createElement('div');
            edadInfo.className = 'edad-info';
            edadInfo.textContent = `Última edad ${evaluacionInfo.tipo}: ${evaluacionInfo.etiquetaEdad}`;
            nombre.appendChild(nombreTexto);
            nombre.appendChild(edadInfo);
            const estadoContainer = document.createElement('div');
            estadoContainer.className = 'estado-container';
            const slider = document.createElement('div');
            slider.className = 'estado-slider';
            slider.tabIndex = 0;
            slider.setAttribute('data-evaluacion', evaluacionInfo.key);
            const thumb = document.createElement('div');
            thumb.className = 'estado-thumb no-disponible';
            const label = document.createElement('div');
            label.className = 'estado-label no-disponible';
            label.textContent = 'No disponible';
            slider.appendChild(thumb);
            estadoContainer.appendChild(slider);
            estadoContainer.appendChild(label);
            item.appendChild(nombre);
            item.appendChild(estadoContainer);

            // Inicializar estado - verificar si ya existe o usar por defecto
            if (evaluacionesData[evaluacionInfo.key] === undefined) {
                evaluacionesData[evaluacionInfo.key] = 1;
            }

            // Aplicar estado inicial cargado si existe
            const estadoInicial = evaluacionesData[evaluacionInfo.key];
            const estadoInfo = estados[estadoInicial];
            thumb.className = `estado-thumb ${estadoInfo.clase}`;
            label.className = `estado-label ${estadoInfo.clase}`;
            label.textContent = estadoInfo.texto;
            // Eventos del slider
            slider.addEventListener('click', function (e) {
                const rect = slider.getBoundingClientRect();
                const x = e.clientX - rect.left;
                const width = rect.width;
                let nuevoEstado;
                if (x < width / 3) {
                    nuevoEstado = 0;
                } else if (x < (2 * width) / 3) {
                    nuevoEstado = 1;
                } else {
                    nuevoEstado = 2;
                }
                actualizarEstado(evaluacionInfo.key, nuevoEstado, thumb, label);
            });
            slider.addEventListener('focus', function () {
                focusedSlider = evaluacionInfo.key;
            });
            slider.addEventListener('blur', function () {
                focusedSlider = null;
            });
            return item;
        }

        function crearItemEvaluacionVencida(evaluacionInfo) {
            const item = document.createElement('div');
            item.className = 'evaluacion-item';
            const nombre = document.createElement('div');
            nombre.className = 'evaluacion-name vencida';
            const nombreTexto = document.createElement('div');
            nombreTexto.textContent = nombresEvaluaciones[evaluacionInfo.key] || evaluacionInfo.key;
            const edadInfo = document.createElement('div');
            edadInfo.className = 'edad-info vencida';
            edadInfo.textContent = `Última edad ${evaluacionInfo.tipo}: ${evaluacionInfo.etiquetaEdad}`;
            nombre.appendChild(nombreTexto);
            nombre.appendChild(edadInfo);
            const estadoContainer = document.createElement('div');
            estadoContainer.className = 'estado-container';
            const slider = document.createElement('div');
            slider.className = 'estado-slider';
            slider.tabIndex = 0;
            slider.setAttribute('data-evaluacion', evaluacionInfo.key);
            const thumb = document.createElement('div');
            thumb.className = 'estado-thumb no-disponible';
            const label = document.createElement('div');
            label.className = 'estado-label no-disponible';
            label.textContent = 'No disponible';
            slider.appendChild(thumb);
            estadoContainer.appendChild(slider);
            estadoContainer.appendChild(label);
            item.appendChild(nombre);
            item.appendChild(estadoContainer);

            // Inicializar estado - verificar si ya existe o usar por defecto
            if (evaluacionesData[evaluacionInfo.key] === undefined) {
                evaluacionesData[evaluacionInfo.key] = 1;
            }

            // Aplicar estado inicial cargado si existe
            const estadoInicial = evaluacionesData[evaluacionInfo.key];
            const estadoInfo = estados[estadoInicial];
            thumb.className = `estado-thumb ${estadoInfo.clase}`;
            label.className = `estado-label ${estadoInfo.clase}`;
            label.textContent = estadoInfo.texto;
            // Eventos del slider
            slider.addEventListener('click', function (e) {
                const rect = slider.getBoundingClientRect();
                const x = e.clientX - rect.left;
                const width = rect.width;
                let nuevoEstado;
                if (x < width / 3) {
                    nuevoEstado = 0;
                } else if (x < (2 * width) / 3) {
                    nuevoEstado = 1;
                } else {
                    nuevoEstado = 2;
                }
                actualizarEstado(evaluacionInfo.key, nuevoEstado, thumb, label);
            });
            slider.addEventListener('focus', function () {
                focusedSlider = evaluacionInfo.key;
            });
            slider.addEventListener('blur', function () {
                focusedSlider = null;
            });
            return item;
        }

        // Función para aplicar los estados de evaluación cargados desde un registro existente
        function aplicarEstadosEvaluacionCargados() {
            console.log('Aplicando estados de evaluación cargados');

            // Si hay estados de evaluación cargados, actualizar los controles visuales
            if (Object.keys(evaluacionesData).length > 0) {
                console.log('Estados cargados encontrados:', evaluacionesData);

                // Iterar sobre todos los sliders y actualizar sus estados
                document.querySelectorAll('.estado-slider').forEach(slider => {
                    const evaluacionKey = slider.getAttribute('data-evaluacion');
                    if (evaluacionKey && evaluacionesData.hasOwnProperty(evaluacionKey)) {
                        const estado = evaluacionesData[evaluacionKey];
                        const thumb = slider.querySelector('.estado-thumb');
                        const label = slider.parentElement.querySelector('.estado-label');

                        if (thumb && label) {
                            const estadoInfo = estados[estado];
                            thumb.className = `estado-thumb ${estadoInfo.clase}`;
                            label.className = `estado-label ${estadoInfo.clase}`;
                            label.textContent = estadoInfo.texto;
                            console.log(`Estado aplicado para ${evaluacionKey}: ${estadoInfo.texto}`);
                        }
                    }
                });

                console.log('Estados de evaluación aplicados exitosamente');
            } else {
                console.log('No se encontraron estados de evaluación previamente cargados');
            }
        }

        // Función para guardar evaluación específicamente para generar informe
        async function guardarEvaluacionParaInforme() {
            console.log('Guardando evaluación para generar informe...');
            return new Promise((resolve, reject) => {
                // Reutilizar la lógica de guardarEvaluacion pero con resolución de promesa
                const originalGuardarEvaluacion = guardarEvaluacion;

                // Temporal override para capturar el resultado
                window.tempResolveInforme = resolve;
                window.tempRejectInforme = reject;

                guardarEvaluacion();

                // Timeout de seguridad
                setTimeout(() => {
                    resolve();
                }, 5000);
            });
        }

        // Función para guardar evaluación completa de forma síncrona para informe
        async function guardarEvaluacionCompleta() {
            return new Promise((resolve, reject) => {
                try {
                    console.log('Guardando evaluación completa...');

                    // Usar la función existente de guardar evaluación
                    const originalFunction = guardarEvaluacion;

                    // Simular guardar evaluación y resolver promesa
                    originalFunction();

                    // Dar tiempo para que se complete el guardado
                    setTimeout(() => {
                        console.log('Evaluación guardada completamente');
                        resolve();
                    }, 1000);

                } catch (error) {
                    console.error('Error guardando evaluación completa:', error);
                    reject(error);
                }
            });
        }

        // Función para preparar datos completos para el nuevo informe
        async function prepararDatosParaNuevoInforme() {
            console.log('Preparando datos para el nuevo informe...');
            try {
                // Siempre leer el archivo recién guardado para obtener el registro más actualizado
                const nombreArchivo = sessionStorage.getItem('registroArchivo');
                let registroCompleto = {};
                if (nombreArchivo && window.api && window.api.leerRegistroJSON) {
                    try {
                        registroCompleto = await window.api.leerRegistroJSON(nombreArchivo);
                        console.log('Registro cargado desde archivo:', nombreArchivo);
                    } catch (error) {
                        console.error('Error cargando registro desde archivo:', error);
                        throw new Error('No se pudo cargar el registro para generar el informe');
                    }
                } else {
                    // Fallback: intentar obtener desde sessionStorage
                    registroCompleto = JSON.parse(sessionStorage.getItem('registroRescatado') || '{}');
                    if (!registroCompleto || !registroCompleto.codigoRegistro) {
                        throw new Error('No se encontró información del registro para generar el informe');
                    }
                }

                // Asegurar que tengamos los datos de seguimiento necesarios para el informe
                if (!registroCompleto.datosSeguimiento && datosSeguimiento) {
                    registroCompleto.datosSeguimiento = datosSeguimiento;
                }
                if (!registroCompleto.nombresEvaluaciones && nombresEvaluaciones) {
                    registroCompleto.nombresEvaluaciones = nombresEvaluaciones;
                }
                // Actualizar metadatos para el informe
                if (!registroCompleto.metadata) {
                    registroCompleto.metadata = {};
                }
                registroCompleto.metadata.fechaInforme = new Date().toISOString();
                registroCompleto.metadata.version = registroCompleto.metadata.version || '1.0.0';
                // Sincronizar evaluacionesData con los valores actuales del formulario
                if (!registroCompleto.evaluaciones) {
                    registroCompleto.evaluaciones = {};
                }
                registroCompleto.evaluaciones.estadoActual = { ...evaluacionesData };
                registroCompleto.evaluaciones.resumen = generarResumen();
                registroCompleto.cumplimiento = calcularCumplimientoJSON();
                console.log('Datos de evaluaciones sincronizados:', registroCompleto.evaluaciones.estadoActual);
                console.log('Datos de cumplimiento calculados:', registroCompleto.cumplimiento);
                // Guardar datos completos para el informe
                sessionStorage.setItem('datosInforme', JSON.stringify(registroCompleto));
                // Determinar nombre del archivo de registro
                let nombreArchivoFinal = sessionStorage.getItem('registroArchivo');
                if (!nombreArchivoFinal && registroCompleto.codigoRegistro) {
                    nombreArchivoFinal = `registro-${registroCompleto.codigoRegistro}.json`;
                }
                if (nombreArchivoFinal) {
                    sessionStorage.setItem('archivoRegistroInforme', nombreArchivoFinal);
                }
                console.log('Datos preparados para nuevo informe (registro completo integrado):', registroCompleto);
            } catch (error) {
                console.error('Error preparando datos para nuevo informe:', error);
                throw error;
            }
        }

        // Función auxiliar para obtener lista de archivos de registros
        async function obtenerArchivosRegistros() {
            try {
                if (window.api && window.api.listarArchivosRegistros) {
                    return await window.api.listarArchivosRegistros();
                }
                return [];
            } catch (error) {
                console.error('Error obteniendo archivos de registros:', error);
                return [];
            }
        }

    </script>
</body>

</html>