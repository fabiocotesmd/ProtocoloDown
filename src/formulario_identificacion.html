<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Protocolo de Atenci√≥n - S√≠ndrome de Down</title>
    <link rel="icon" type="image/png" href="favicon.png">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background-color: #f0f9f9;
            color: #1a1a1a;
            line-height: 1.6;
            padding: 16px;
        }

        .container {
            max-width: 600px;
            margin: 0 auto;
            background-color: white;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 128, 128, 0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #20b2aa, #40e0d0);
            color: white;
            padding: 24px 20px;
            text-align: center;
        }

        .header h1 {
            font-size: 1.4rem;
            font-weight: 600;
            margin-bottom: 8px;
            line-height: 1.3;
        }

        .header p {
            font-size: 0.9rem;
            opacity: 0.9;
            margin-bottom: 12px;
        }

        .disclaimer {
            background-color: rgba(255, 255, 255, 0.1);
            padding: 12px;
            border-radius: 8px;
            font-size: 0.8rem;
            border-left: 3px solid white;
        }

        .form-container {
            padding: 24px 20px 32px;
        }

        /* Estilos del Acorde√≥n */
        .accordion {
            margin-bottom: 24px;
        }

        .accordion-item {
            border: 2px solid #e0f2f1;
            border-radius: 8px;
            margin-bottom: 12px;
            overflow: hidden;
            transition: all 0.3s ease;
        }

        .accordion-item.active {
            border-color: #20b2aa;
            box-shadow: 0 2px 8px rgba(32, 178, 170, 0.1);
        }

        .accordion-header {
            background: linear-gradient(135deg, #5fb3b3, #6bc7c7);
            color: white;
            padding: 18px 24px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: 500;
            font-size: 1.1rem;
            transition: all 0.3s ease;
            position: relative;
            border-radius: 8px 8px 0 0;
        }

        .accordion-item:not(.active) .accordion-header {
            border-radius: 8px;
        }

        .accordion-header:hover {
            background: linear-gradient(135deg, #4da6a6, #5bb8b8);
        }

        .accordion-header::after {
            content: '‚ñ≤';
            font-size: 0.9rem;
            font-weight: bold;
            transition: transform 0.3s ease;
        }

        .accordion-item:not(.active) .accordion-header::after {
            transform: rotate(180deg);
        }

        .accordion-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
            background-color: white;
        }

        .accordion-item.active .accordion-content {
            max-height: 1000px;
        }

        .accordion-body {
            padding: 24px 20px;
        }

        .form-section {
            margin-bottom: 20px;
        }

        .form-row {
            display: flex;
            flex-wrap: wrap;
            gap: 16px;
            margin-bottom: 20px;
        }

        .form-group {
            flex: 1;
            min-width: 250px;
            display: flex;
            flex-direction: column;
        }

        .form-group.half {
            min-width: 120px;
        }

        .form-group.quarter {
            min-width: 80px;
        }

        label {
            color: #2c5454;
            font-weight: 500;
            margin-bottom: 6px;
            font-size: 0.9rem;
        }

        input[type="text"],
        input[type="number"],
        input[type="email"],
        input[type="tel"],
        input[type="date"] {
            padding: 12px 16px;
            border: 2px solid #e0f2f1;
            border-radius: 8px;
            font-size: 1rem;
            background-color: white;
            color: #1a1a1a;
            transition: border-color 0.3s ease, box-shadow 0.3s ease;
        }

        input[type="text"]:focus,
        input[type="number"]:focus,
        input[type="email"]:focus,
        input[type="tel"]:focus,
        input[type="date"]:focus {
            outline: none;
            border-color: #20b2aa;
            box-shadow: 0 0 0 3px rgba(32, 178, 170, 0.1);
        }

        input[type="text"]:invalid,
        input[type="number"]:invalid,
        input[type="email"]:invalid,
        input[type="tel"]:invalid,
        input[type="date"]:invalid {
            border-color: #ff6b6b;
        }

        .age-group {
            display: flex;
            gap: 12px;
            align-items: end;
        }

        .age-input {
            flex: 1;
            min-width: 60px;
        }

        .age-label {
            color: #666;
            font-size: 0.85rem;
            margin-top: 8px;
            white-space: nowrap;
        }

        .readonly-field {
            background-color: #f8fffe;
            border-color: #b2dfdb;
            color: #666;
        }

        .button-container {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 32px;
        }

        .button-container.single {
            justify-content: center;
        }

        .button-container.dual {
            justify-content: space-between;
            max-width: 400px;
            margin-left: auto;
            margin-right: auto;
        }

        .btn {
            padding: 14px 28px;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            min-width: auto;
            width: auto;
        }

        .btn-primary {
            background: linear-gradient(135deg, #20b2aa, #40e0d0);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(32, 178, 170, 0.3);
        }

        .btn-search {
            background: linear-gradient(135deg, #4a90e2, #67b3f0);
            color: white;
        }

        .btn-search:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(74, 144, 226, 0.3);
        }

        .btn-link {
            background: none;
            border: none;
            color: #20b2aa;
            text-decoration: underline;
            cursor: pointer;
            font-size: inherit;
            padding: 4px 8px;
            border-radius: 4px;
            transition: background 0.2s;
        }

        .btn-link:hover {
            background: rgba(32, 178, 170, 0.1);
            text-decoration: none;
        }

        .btn-secondary {
            background: #f5f5f5;
            color: #666;
            border: 2px solid #e0e0e0;
        }

        .btn-secondary:hover {
            background: #e0e0e0;
            transform: translateY(-1px);
        }

        /* Ocultar flechas de input number */
        input[type="number"]::-webkit-outer-spin-button,
        input[type="number"]::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }

        input[type="number"] {
            appearance: textfield;
            -moz-appearance: textfield;
        }

        /* Indicador de completado */
        .completion-indicator {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background-color: rgba(255, 255, 255, 0.3);
            border: 2px solid white;
            transition: all 0.3s ease;
            margin-right: 12px;
        }

        .completion-indicator.completed {
            background-color: #4caf50;
            border-color: #4caf50;
        }

        .completion-indicator.completed::after {
            content: '‚úì';
            color: white;
            font-size: 12px;
            font-weight: bold;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }

        .accordion-header .title {
            display: flex;
            align-items: center;
        }

        /* Mobile optimizations */
        @media (max-width: 480px) {
            body {
                padding: 8px;
            }

            .container {
                border-radius: 8px;
            }

            .header {
                padding: 20px 16px;
            }

            .header h1 {
                font-size: 1.2rem;
            }

            .form-container {
                padding: 20px 16px 28px;
            }

            .accordion-body {
                padding: 20px 16px;
            }

            .form-group {
                min-width: 100%;
            }

            .form-group.half,
            .form-group.quarter {
                min-width: 100%;
            }

            .age-group {
                flex-direction: column;
                gap: 8px;
            }

            .age-group .form-group {
                min-width: auto;
            }

            .button-container.single {
                justify-content: center;
            }

            .button-container.dual {
                flex-direction: column;
                gap: 12px;
                max-width: none;
            }

            .btn {
                min-width: auto;
                width: auto;
            }

            .accordion-header {
                padding: 16px 20px;
                font-size: 1rem;
            }

            .accordion-header .title {
                font-size: 0.95rem;
            }

            .completion-indicator {
                width: 18px;
                height: 18px;
                margin-right: 10px;
            }

            .accordion-header::after {
                font-size: 0.8rem;
            }
        }

        @media (max-width: 320px) {
            .header h1 {
                font-size: 1.1rem;
            }

            .disclaimer {
                font-size: 0.75rem;
            }

            input[type="text"],
            input[type="number"],
            input[type="email"],
            input[type="tel"],
            input[type="date"] {
                padding: 10px 12px;
                font-size: 0.95rem;
            }
        }

        /* Estilo para el c√≠rculo de informaci√≥n de desarrolladores */
        .dev-info-circle {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: linear-gradient(135deg, #20b2aa, #40e0d0);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(32, 178, 170, 0.3);
            transition: all 0.3s ease;
            z-index: 1000;
        }

        .dev-info-circle:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 16px rgba(32, 178, 170, 0.4);
        }

        .dev-info-circle img {
            width: 30px;
            height: 30px;
            border-radius: 50%;
        }

        /* Modal para informaci√≥n de desarrolladores */
        .dev-info-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(0, 0, 0, 0.6);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            backdrop-filter: blur(3px);
        }

        .dev-info-content {
            background: white;
            border-radius: 12px;
            padding: 24px;
            max-width: 400px;
            width: 90%;
            text-align: center;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.2);
            animation: modalShow 0.3s ease-out;
        }

        .dev-info-header {
            color: #20b2aa;
            font-size: 1.2rem;
            font-weight: 600;
            margin-bottom: 16px;
        }

        .dev-info-text {
            color: #2c5454;
            line-height: 1.6;
            margin-bottom: 8px;
        }

        .dev-info-link {
            color: #20b2aa;
            text-decoration: none;
            font-weight: 500;
        }

        .dev-info-link:hover {
            text-decoration: underline;
        }

        .dev-info-close {
            position: absolute;
            top: 10px;
            right: 15px;
            background: none;
            border: none;
            font-size: 24px;
            color: #666;
            cursor: pointer;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .dev-info-close:hover {
            color: #20b2aa;
        }

        @keyframes modalShow {
            from {
                opacity: 0;
                transform: scale(0.8);
            }

            to {
                opacity: 1;
                transform: scale(1);
            }
        }
    </style>
</head>

<body>
    <div class="container">
        <div class="header">
            <h1>Cumplimiento del Protocolo de Atenci√≥n M√©dica para Ni√±os, Ni√±as y Adolescentes con S√≠ndrome de Down</h1>
            <p>Formulario de Identificaci√≥n del Paciente</p>
            <div class="disclaimer">
                * Este protocolo se debe seguir en el individuo asintom√°tico, para cumplir su objetivo preventivo.
                Cuando las pruebas de tamizaje (incluyendo hallazgos de la evaluaci√≥n m√©dica) sean anormales, la
                frecuencia de los controles y pruebas o consultas adicionales ser√°n determinadas por el especialista.
            </div>
        </div>

        <div class="form-container">
            <form id="identification-form">
                <div class="accordion">
                    <!-- Secci√≥n 1: Informaci√≥n del Paciente -->
                    <div class="accordion-item" data-section="paciente">
                        <div class="accordion-header">
                            <div class="title">
                                <div class="completion-indicator" id="indicator-paciente"></div>
                                Informaci√≥n del Paciente
                            </div>
                        </div>
                        <div class="accordion-content">
                            <div class="accordion-body">
                                <div class="form-section">
                                    <div class="form-row">
                                        <div class="form-group">
                                            <label for="fecha-diligenciamiento">Fecha de diligenciamiento: *</label>
                                            <input type="date" id="fecha-diligenciamiento" name="fechaDiligenciamiento"
                                                required class="readonly-field" readonly tabindex="-1">
                                        </div>
                                        <div class="form-group">
                                            <label for="identificacion">Identificaci√≥n:</label>
                                            <input type="text" id="identificacion" name="identificacion"
                                                pattern="\d{6,}"
                                                title="Digite n√∫mero de identificaci√≥n (m√≠nimo 6 d√≠gitos)"
                                                placeholder="Solo n√∫meros">
                                        </div>
                                    </div>

                                    <div class="form-row">
                                        <div class="form-group">
                                            <label for="nombre-usuario">Nombre del usuario:</label>
                                            <input type="text" id="nombre-usuario" name="nombreUsuario"
                                                placeholder="Ingrese el nombre completo del paciente" autofocus>
                                        </div>

                                        <div class="form-group">
                                            <label for="fecha-nacimiento">Fecha de nacimiento:</label>
                                            <input type="date" id="fecha-nacimiento" name="fechaNacimiento">
                                        </div>
                                    </div>

                                    <div class="form-row">
                                        <div class="form-group">
                                            <label>Edad actual:</label>
                                            <div class="age-group">
                                                <div class="form-group age-input">
                                                    <input type="number" id="edad-anos" name="edadAnos" min="0" max="18"
                                                        placeholder="0">
                                                    <div class="age-label">a√±os</div>
                                                </div>
                                                <div class="form-group age-input">
                                                    <input type="number" id="edad-meses" name="edadMeses" min="0"
                                                        max="12" placeholder="0">
                                                    <div class="age-label">meses</div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>


                            </div>
                        </div>
                    </div>

                    <!-- Secci√≥n 2: Informaci√≥n del Acudiente -->
                    <div class="accordion-item" data-section="acudiente">
                        <div class="accordion-header">
                            <div class="title">
                                <div class="completion-indicator" id="indicator-acudiente"></div>
                                Informaci√≥n del Acudiente
                            </div>
                        </div>
                        <div class="accordion-content">
                            <div class="accordion-body">
                                <div class="form-section">
                                    <div class="form-row">
                                        <div class="form-group">
                                            <label for="nombre-acudiente">Nombre del acudiente:</label>
                                            <input type="text" id="nombre-acudiente" name="nombreAcudiente"
                                                placeholder="Nombre completo del acudiente">
                                        </div>
                                    </div>

                                    <div class="form-row">
                                        <div class="form-group">
                                            <label for="correo">Correo electr√≥nico:</label>
                                            <input type="email" id="correo" name="correoElectronico"
                                                placeholder="correo@ejemplo.com">
                                        </div>

                                        <div class="form-group">
                                            <label for="telefono">Tel√©fono:</label>
                                            <input type="tel" id="telefono" name="telefono"
                                                placeholder="N√∫mero de tel√©fono">
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Secci√≥n 3: Informaci√≥n del Protocolo -->
                    <div class="accordion-item" data-section="protocolo">
                        <div class="accordion-header">
                            <div class="title">
                                <div class="completion-indicator" id="indicator-protocolo"></div>
                                Informaci√≥n del Protocolo
                            </div>
                        </div>
                        <div class="accordion-content">
                            <div class="accordion-body">
                                <div class="form-section">
                                    <div class="form-row">
                                        <div class="form-group">
                                            <label for="fecha-inicio">Fecha de Inicio:</label>
                                            <input type="date" id="fecha-inicio" name="fechaInicio">
                                        </div>
                                    </div>

                                    <div class="form-row">
                                        <div class="form-group">
                                            <label>Edad Inicio del Protocolo:</label>
                                            <div class="age-group">
                                                <div class="form-group age-input">
                                                    <input type="number" id="edad-inicio-anos" name="edadInicioAnos"
                                                        min="0" max="18" class="readonly-field" readonly
                                                        placeholder="0">
                                                    <div class="age-label">a√±os</div>
                                                </div>
                                                <div class="form-group age-input">
                                                    <input type="number" id="edad-inicio-meses" name="edadInicioMeses"
                                                        min="0" max="12" class="readonly-field" readonly
                                                        placeholder="0">
                                                    <div class="age-label">meses</div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="button-container dual">
                    <button type="button" class="btn btn-search" id="btn-buscar-final" tabindex="-1">Buscar
                        Registro</button>
                    <button type="button" class="btn btn-primary" id="btn-continuar">Guardar y Continuar</button>
                </div>
            </form>
        </div>
    </div>

    <!-- C√≠rculo de informaci√≥n de desarrolladores -->
    <div class="dev-info-circle" id="dev-info-circle">
        <img src="../favicon.png" alt="Co" />
    </div>

    <!-- Modal de informaci√≥n de desarrolladores -->
    <div class="dev-info-modal" id="dev-info-modal">
        <div class="dev-info-content">
            <button class="dev-info-close" id="dev-info-close">&times;</button>
            <div class="dev-info-header">Desarrollado con cari√±o por:</div>
            <div class="dev-info-text">Dr. V√≠ctor Mora, M√©dico Pediatra</div>
            <div class="dev-info-text">Dr. Fabio Cotes, M√©dico de hemodi√°lisis</div>
            <div class="dev-info-text">
                <a href="#" id="redcivil-link" class="dev-info-link">Red Civil SpA</a>
            </div>
        </div>
    </div>

    <script>
        // Variables globales
        let accordionState = {
            paciente: false,
            acudiente: false,
            protocolo: false
        };

        // Establecer fecha actual autom√°ticamente
        document.addEventListener('DOMContentLoaded', function () {
            const fechaActual = new Date().toISOString().split('T')[0];
            document.getElementById('fecha-diligenciamiento').value = fechaActual;

            // Inicializar acorde√≥n
            initializeAccordion();

            // Configurar navegaci√≥n Tab inteligente
            function setupSmartTabNavigation() {
                const sections = ['paciente', 'acudiente', 'protocolo'];

                sections.forEach((section, index) => {
                    // Configurar listener para todos los inputs de la secci√≥n, no solo el √∫ltimo
                    const sectionElement = document.querySelector(`.accordion-item[data-section="${section}"] .accordion-content`);
                    if (!sectionElement) return;

                    const inputs = sectionElement.querySelectorAll('input:not([readonly]):not([tabindex="-1"]), select:not([tabindex="-1"])');
                    if (inputs.length === 0) return;

                    const lastInput = inputs[inputs.length - 1];

                    lastInput.addEventListener('keydown', function (e) {
                        if (e.key === 'Tab' && !e.shiftKey) {
                            const nextSection = getNextSection(section);
                            if (nextSection) {
                                e.preventDefault();

                                // Abrir la siguiente secci√≥n
                                const nextHeader = document.querySelector(`.accordion-item[data-section="${nextSection}"] .accordion-header`);
                                if (nextHeader) {
                                    expandAccordion(nextHeader);

                                    // Enfocar el primer input de la siguiente secci√≥n
                                    setTimeout(() => {
                                        const firstInput = getFirstInputInSection(nextSection);
                                        if (firstInput) {
                                            firstInput.focus();
                                        }
                                    }, 150);
                                }
                            } else {
                                // Si es la √∫ltima secci√≥n, ir directo a "Guardar y Continuar"
                                e.preventDefault();
                                const guardarBtn = document.getElementById('btn-continuar');
                                if (guardarBtn) {
                                    guardarBtn.focus();
                                }
                            }
                        }
                    });
                });
            }

            // Llamar despu√©s de un breve delay para asegurar que el DOM est√© listo
            setTimeout(setupSmartTabNavigation, 200);

            // Configurar comportamiento del bot√≥n "Guardar y Continuar" para que Tab se quede ah√≠
            setTimeout(() => {
                const guardarBtn = document.getElementById('btn-continuar');
                if (guardarBtn) {
                    guardarBtn.addEventListener('keydown', function (e) {
                        if (e.key === 'Tab' && !e.shiftKey) {
                            // Prevenir que Tab vaya al siguiente elemento (volver√≠a al inicio)
                            e.preventDefault();
                            // Mantener el focus en el mismo bot√≥n
                            guardarBtn.focus();
                        }
                    });
                }
            }, 250);

            // Configurar funcionalidad del c√≠rculo de informaci√≥n de desarrolladores
            const devCircle = document.getElementById('dev-info-circle');
            const devModal = document.getElementById('dev-info-modal');
            const devClose = document.getElementById('dev-info-close');
            const redcivilLink = document.getElementById('redcivil-link');

            devCircle.addEventListener('click', function () {
                devModal.style.display = 'flex';
            });

            devClose.addEventListener('click', function () {
                devModal.style.display = 'none';
            });

            // Cerrar modal al hacer clic fuera del contenido
            devModal.addEventListener('click', function (e) {
                if (e.target === devModal) {
                    devModal.style.display = 'none';
                }
            });

            // Cerrar modal con tecla Escape
            document.addEventListener('keydown', function (e) {
                if (e.key === 'Escape' && devModal.style.display === 'flex') {
                    devModal.style.display = 'none';
                }
            });

            // Abrir enlace en navegador externo
            redcivilLink.addEventListener('click', function (e) {
                e.preventDefault();
                if (window.electronAPI && window.electronAPI.openExternal) {
                    window.electronAPI.openExternal('https://redcivil.org');
                } else {
                    // Fallback si no est√° disponible la API
                    window.open('https://redcivil.org', '_blank');
                }
            });

            // Foco inicial en el bot√≥n Buscar Registros
            setTimeout(() => {
                const buscarBtn = document.getElementById('btn-buscar-final');
                if (buscarBtn) buscarBtn.focus();
            }, 0);

            // Calcular edad autom√°ticamente cuando se ingrese fecha de nacimiento
            const fechaNacimientoInput = document.getElementById('fecha-nacimiento');
            const fechaInicioInput = document.getElementById('fecha-inicio');
            const identificacionInput = document.getElementById('identificacion');

            fechaNacimientoInput.addEventListener('change', calcularEdadActual);
            fechaInicioInput.addEventListener('change', calcularEdadInicio);
            identificacionInput.addEventListener('input', formatearIdentificacion);

            // Eventos para campos de edad manual
            const edadAnosInput = document.getElementById('edad-anos');
            const edadMesesInput = document.getElementById('edad-meses');

            edadAnosInput.addEventListener('input', calcularFechaNacimiento);
            edadMesesInput.addEventListener('input', calcularFechaNacimiento);

            // Eventos para validar completado de secciones
            document.querySelectorAll('input').forEach(input => {
                input.addEventListener('input', updateCompletionStatus);
                input.addEventListener('change', updateCompletionStatus);
            });

            function initializeAccordion() {
                const accordionHeaders = document.querySelectorAll('.accordion-header');
                accordionHeaders.forEach((header, idx) => {
                    header.setAttribute('tabindex', '0'); // Hacer navegable por tab
                    header.addEventListener('click', function () {
                        const item = header.parentElement;
                        const isActive = item.classList.contains('active');

                        if (isActive) {
                            collapseAccordion(header);
                        } else {
                            expandAccordion(header);
                        }
                    });
                    header.addEventListener('keydown', function (e) {
                        const items = Array.from(document.querySelectorAll('.accordion-header'));
                        if (e.key === 'ArrowDown') {
                            e.preventDefault();
                            const next = items[idx + 1] || items[0];
                            next.focus();
                        } else if (e.key === 'ArrowUp') {
                            e.preventDefault();
                            const prev = items[idx - 1] || items[items.length - 1];
                            prev.focus();
                        } else if (e.key === 'ArrowRight') {
                            e.preventDefault();
                            expandAccordion(header);
                        } else if (e.key === 'ArrowLeft') {
                            e.preventDefault();
                            collapseAccordion(header);
                        } else if (e.key === 'Enter' || e.key === ' ') {
                            e.preventDefault();
                            expandAccordion(header);
                        }
                    });
                });
            }

            function collapseAccordion(header) {
                const item = header.parentElement;
                const section = item.getAttribute('data-section');
                item.classList.remove('active');
                accordionState[section] = false;
            }

            // Funciones auxiliares para navegaci√≥n Tab inteligente (globales)
            function getLastInputInSection(section) {
                const sectionElement = document.querySelector(`.accordion-item[data-section="${section}"] .accordion-content`);
                if (!sectionElement) return null;

                const inputs = sectionElement.querySelectorAll('input:not([readonly]):not([tabindex="-1"]), select:not([tabindex="-1"])');
                return inputs.length > 0 ? inputs[inputs.length - 1] : null;
            }

            function getNextSection(currentSection) {
                const sections = ['paciente', 'acudiente', 'protocolo'];
                const currentIndex = sections.indexOf(currentSection);
                return currentIndex < sections.length - 1 ? sections[currentIndex + 1] : null;
            }

            function getFirstInputInSection(section) {
                const sectionElement = document.querySelector(`.accordion-item[data-section="${section}"] .accordion-content`);
                if (!sectionElement) return null;

                const inputs = sectionElement.querySelectorAll('input:not([readonly]):not([tabindex="-1"]), select:not([tabindex="-1"])');
                return inputs.length > 0 ? inputs[0] : null;
            }

            function expandAccordion(header) {
                const item = header.parentElement;
                const section = item.getAttribute('data-section');
                document.querySelectorAll('.accordion-item').forEach(i => {
                    i.classList.remove('active');
                    const sec = i.getAttribute('data-section');
                    accordionState[sec] = false;
                });
                item.classList.add('active');
                accordionState[section] = true;
            }

            function updateCompletionStatus() {
                // Validar secci√≥n paciente (solo para indicador visual, no para guardar)
                const identificacion = document.getElementById('identificacion').value;
                const nombreUsuario = document.getElementById('nombre-usuario').value;
                const fechaNacimiento = document.getElementById('fecha-nacimiento').value;
                const pacienteCompleto = identificacion.replace(/[\.']/g, '').length >= 6 && nombreUsuario.trim() && fechaNacimiento;
                updateIndicator('paciente', pacienteCompleto);

                // Validar secci√≥n acudiente (solo para indicador visual)
                const nombreAcudiente = document.getElementById('nombre-acudiente').value;
                const correo = document.getElementById('correo').value;
                const telefono = document.getElementById('telefono').value;
                const acudienteCompleto = nombreAcudiente.trim() && (correo.trim() || telefono.trim());
                updateIndicator('acudiente', acudienteCompleto);

                // Validar secci√≥n protocolo (solo para indicador visual)
                const fechaInicio = document.getElementById('fecha-inicio').value;
                const protocoloCompleto = fechaInicio;
                updateIndicator('protocolo', protocoloCompleto);
            }

            function updateIndicator(section, completed) {
                const indicator = document.getElementById(`indicator-${section}`);
                if (completed) {
                    indicator.classList.add('completed');
                } else {
                    indicator.classList.remove('completed');
                }
            }

            function calcularFechaNacimiento() {
                const anos = parseInt(edadAnosInput.value) || 0;
                const meses = parseInt(edadMesesInput.value) || 0;

                // Si hay valores de edad manual, dejar fecha de nacimiento como no disponible
                if (anos > 0 || meses > 0) {
                    // Si el usuario ingresa edad manual, no establecer fecha de nacimiento
                    fechaNacimientoInput.value = '';
                }

                // Recalcular edad de inicio si hay fecha de inicio
                if (fechaInicioInput.value) {
                    calcularEdadInicio();
                }

                updateCompletionStatus();
            }

            function formatearIdentificacion() {
                let value = this.value.replace(/\D/g, ''); // Solo n√∫meros
                this.value = value;
                // Validar longitud m√≠nima
                if (value.length >= 6) {
                    this.setCustomValidity('');
                } else if (value.length > 0) {
                    this.setCustomValidity('La identificaci√≥n debe tener m√≠nimo 6 d√≠gitos');
                } else {
                    this.setCustomValidity('');
                }
                updateCompletionStatus();
            }

            function calcularEdadActual() {
                const fechaNacimiento = new Date(fechaNacimientoInput.value);
                const hoy = new Date();

                if (fechaNacimientoInput.value) {
                    calcularEdad(fechaNacimiento, hoy, 'edad-anos', 'edad-meses');
                }

                updateCompletionStatus();
            }

            function calcularEdadInicio() {
                const fechaNacimiento = new Date(fechaNacimientoInput.value);
                const fechaInicio = new Date(fechaInicioInput.value);

                if (fechaNacimientoInput.value && fechaInicioInput.value) {
                    calcularEdad(fechaNacimiento, fechaInicio, 'edad-inicio-anos', 'edad-inicio-meses');
                } else if (fechaInicioInput.value) {
                    // Si no hay fecha de nacimiento pero s√≠ edad actual, calcular edad de inicio
                    const edadActualAnos = parseInt(document.getElementById('edad-anos').value) || 0;
                    const edadActualMeses = parseInt(document.getElementById('edad-meses').value) || 0;

                    if (edadActualAnos > 0 || edadActualMeses > 0) {
                        const hoy = new Date();
                        const fechaInicio = new Date(fechaInicioInput.value);
                        const mesesDiferencia = (hoy.getFullYear() - fechaInicio.getFullYear()) * 12 + (hoy.getMonth() - fechaInicio.getMonth());

                        const edadTotalMesesActual = edadActualAnos * 12 + edadActualMeses;
                        const edadTotalMesesInicio = edadTotalMesesActual - mesesDiferencia;

                        if (edadTotalMesesInicio >= 0) {
                            const anosInicio = Math.floor(edadTotalMesesInicio / 12);
                            const mesesInicio = edadTotalMesesInicio % 12;

                            document.getElementById('edad-inicio-anos').value = anosInicio;
                            document.getElementById('edad-inicio-meses').value = mesesInicio;
                        }
                    }
                }

                updateCompletionStatus();
            }

            function calcularEdad(fechaInicio, fechaFin, campoAnos, campoMeses) {
                if (!fechaInicio || !fechaFin) return;

                let anos = fechaFin.getFullYear() - fechaInicio.getFullYear();
                let meses = fechaFin.getMonth() - fechaInicio.getMonth();

                if (meses < 0) {
                    anos--;
                    meses += 12;
                }

                if (fechaFin.getDate() < fechaInicio.getDate()) {
                    meses--;
                    if (meses < 0) {
                        anos--;
                        meses += 12;
                    }
                }

                document.getElementById(campoAnos).value = Math.max(0, anos);
                document.getElementById(campoMeses).value = Math.max(0, meses);
            }

            // Eventos de botones

            document.getElementById('btn-buscar-final').addEventListener('click', mostrarMenuBusqueda);

            // Crear modal/menu para criterios de b√∫squeda
            function mostrarMenuBusqueda() {
                let modal = document.getElementById('modal-busqueda');
                if (!modal) {
                    modal = document.createElement('div');
                    modal.id = 'modal-busqueda';
                    modal.style.cssText = `
                        position: fixed;
                        top: 0;
                        left: 0;
                        width: 100vw;
                        height: 100vh;
                        background: rgba(0,0,0,0.6);
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        z-index: 1000;
                        backdrop-filter: blur(3px);
                    `;

                    modal.innerHTML = `
                        <div style="
                            background: white;
                            padding: 0;
                            border-radius: 12px;
                            min-width: 400px;
                            max-width: 90vw;
                            max-height: 80vh;
                            overflow: hidden;
                            box-shadow: 0 20px 40px rgba(0,0,0,0.2);
                            animation: modalShow 0.3s ease-out;
                        ">
                            <!-- Header del modal -->
                            <div style="
                                background: linear-gradient(135deg, #20b2aa, #40e0d0);
                                color: white;
                                padding: 20px 24px;
                                display: flex;
                                justify-content: space-between;
                                align-items: center;
                            ">
                                <h3 style="margin: 0; font-size: 1.2rem; font-weight: 600;">üîç Buscar Registro de Paciente</h3>
                                <button id="btn-cerrar-busqueda" style="
                                    background: rgba(255,255,255,0.2);
                                    border: none;
                                    color: white;
                                    width: 32px;
                                    height: 32px;
                                    border-radius: 50%;
                                    cursor: pointer;
                                    display: flex;
                                    align-items: center;
                                    justify-content: center;
                                    font-size: 18px;
                                    transition: background 0.2s;
                                " onmouseover="this.style.background='rgba(255,255,255,0.3)'" onmouseout="this.style.background='rgba(255,255,255,0.2)'">√ó</button>
                            </div>
                            
                            <!-- Contenido del modal -->
                            <div style="padding: 24px;">
                                <div style="margin-bottom: 20px;">
                                    <label style="display: block; margin-bottom: 8px; font-weight: 500; color: #2c5454;">Criterio de b√∫squeda:</label>
                                    <select id="criterio-busqueda" style="
                                        width: 100%;
                                        padding: 12px 16px;
                                        border: 2px solid #e0f2f1;
                                        border-radius: 8px;
                                        font-size: 1rem;
                                        background: white;
                                        transition: border-color 0.3s;
                                    " onfocus="this.style.borderColor='#20b2aa'" onblur="this.style.borderColor='#e0f2f1'">
                                        <option value="identificacion">N√∫mero de identificaci√≥n</option>
                                        <option value="nombre">Nombre del paciente</option>
                                        <option value="ultima">√öltima atenci√≥n (5 m√°s recientes)</option>
                                    </select>
                                </div>
                                
                                <div style="margin-bottom: 24px;" id="container-valor-busqueda">
                                    <label style="display: block; margin-bottom: 8px; font-weight: 500; color: #2c5454;">Valor a buscar:</label>
                                    <input 
                                        id="valor-busqueda" 
                                        type="text" 
                                        placeholder="Ingrese el valor para buscar" 
                                        style="
                                            width: 100%;
                                            padding: 12px 16px;
                                            border: 2px solid #e0f2f1;
                                            border-radius: 8px;
                                            font-size: 1rem;
                                            transition: border-color 0.3s;
                                        "
                                        onfocus="this.style.borderColor='#20b2aa'"
                                        onblur="this.style.borderColor='#e0f2f1'"
                                        onkeypress="if(event.key==='Enter') document.getElementById('btn-ejecutar-busqueda').click()"
                                    />
                                    <div id="ayuda-busqueda" style="font-size: 0.85rem; color: #666; margin-top: 6px;">Ingrese el n√∫mero de identificaci√≥n del paciente</div>
                                </div>
                                
                                <div style="display: flex; gap: 12px; margin-bottom: 20px;">
                                    <button id="btn-ejecutar-busqueda" style="
                                        flex: 1;
                                        padding: 12px 20px;
                                        background: linear-gradient(135deg, #20b2aa, #40e0d0);
                                        color: white;
                                        border: none;
                                        border-radius: 8px;
                                        font-size: 1rem;
                                        font-weight: 600;
                                        cursor: pointer;
                                        transition: transform 0.2s, box-shadow 0.2s;
                                    " onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 12px rgba(32, 178, 170, 0.3)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none'">Buscar</button>
                                    <button id="btn-limpiar-busqueda" style="
                                        padding: 12px 20px;
                                        background: #f5f5f5;
                                        color: #666;
                                        border: 2px solid #e0e0e0;
                                        border-radius: 8px;
                                        font-size: 1rem;
                                        cursor: pointer;
                                        transition: background 0.2s;
                                    " onmouseover="this.style.background='#e0e0e0'" onmouseout="this.style.background='#f5f5f5'">Limpiar</button>
                                </div>
                                
                                <div id="resultados-busqueda" style="
                                    max-height: 400px;
                                    overflow-y: auto;
                                    border-top: 1px solid #e0f2f1;
                                    margin-top: 20px;
                                    padding-top: 20px;
                                "></div>
                            </div>
                        </div>
                    `;

                    // Agregar estilos de animaci√≥n
                    if (!document.getElementById('modal-styles')) {
                        const style = document.createElement('style');
                        style.id = 'modal-styles';
                        style.textContent = `
                            @keyframes modalShow {
                                from {
                                    opacity: 0;
                                    transform: scale(0.9) translateY(-20px);
                                }
                                to {
                                    opacity: 1;
                                    transform: scale(1) translateY(0);
                                }
                            }
                        `;
                        document.head.appendChild(style);
                    }

                    document.body.appendChild(modal);

                    // Event listeners
                    document.getElementById('btn-cerrar-busqueda').onclick = () => modal.remove();
                    document.getElementById('btn-ejecutar-busqueda').onclick = ejecutarBusqueda;
                    document.getElementById('btn-limpiar-busqueda').onclick = () => {
                        document.getElementById('valor-busqueda').value = '';
                        document.getElementById('resultados-busqueda').innerHTML = '';
                        document.getElementById('valor-busqueda').focus();
                    };

                    // Cambiar placeholder y ayuda seg√∫n criterio
                    document.getElementById('criterio-busqueda').onchange = function () {
                        const valorInput = document.getElementById('valor-busqueda');
                        const ayudaDiv = document.getElementById('ayuda-busqueda');
                        const containerValor = document.getElementById('container-valor-busqueda');

                        if (this.value === 'identificacion') {
                            valorInput.placeholder = 'Ej: 1234567890';
                            ayudaDiv.textContent = 'Ingrese el n√∫mero de identificaci√≥n del paciente';
                            containerValor.style.display = 'block';
                        } else if (this.value === 'nombre') {
                            valorInput.placeholder = 'Ej: Juan P√©rez';
                            ayudaDiv.textContent = 'Ingrese parte del nombre del paciente';
                            containerValor.style.display = 'block';
                        } else if (this.value === 'ultima') {
                            valorInput.placeholder = '';
                            valorInput.value = '';
                            ayudaDiv.textContent = 'Se mostrar√°n los 5 registros con atenci√≥n m√°s reciente';
                            containerValor.style.display = 'none';
                        }
                        document.getElementById('resultados-busqueda').innerHTML = '';
                    };

                    // Cerrar modal al hacer clic fuera
                    modal.onclick = function (e) {
                        if (e.target === modal) {
                            modal.remove();
                        }
                    };

                    // Focus en el input
                    setTimeout(() => {
                        document.getElementById('valor-busqueda').focus();
                    }, 100);

                } else {
                    modal.style.display = 'flex';
                    document.getElementById('valor-busqueda').focus();
                }
            }

            async function ejecutarBusqueda() {
                const criterio = document.getElementById('criterio-busqueda').value;
                const valor = document.getElementById('valor-busqueda').value.trim();
                const resultadosDiv = document.getElementById('resultados-busqueda');

                // Validar entrada (excepto para √∫ltima atenci√≥n que no requiere valor)
                if (criterio !== 'ultima' && !valor) {
                    resultadosDiv.innerHTML = '<div style="color:#f44336;padding:10px;">Por favor ingrese un valor para buscar.</div>';
                    return;
                }

                resultadosDiv.innerHTML = '<div style="text-align:center;padding:20px;">üîç Buscando registros...</div>';

                try {
                    // Verificar que la API de Electron est√© disponible
                    if (!window.api || !window.api.leerRegistroJSON || !window.api.listarArchivosRegistros) {
                        throw new Error('API de archivos no disponible. Verifica la configuraci√≥n de Electron.');
                    }

                    // Obtener lista de archivos desde la carpeta registros usando la API
                    let archivos = [];
                    try {
                        archivos = await window.api.listarArchivosRegistros();
                    } catch (e) {
                        console.error('Error listando archivos:', e);
                        resultadosDiv.innerHTML = '<div style="color:#f44336;padding:10px;">Error: No se pudo acceder a la carpeta de registros.</div>';
                        return;
                    }

                    if (archivos.length === 0) {
                        resultadosDiv.innerHTML = '<div style="color:#666;padding:10px;">No se encontraron registros en el sistema.</div>';
                        return;
                    }

                    let resultados = [];
                    const valorBusqueda = valor.toLowerCase();

                    for (const archivo of archivos) {
                        try {
                            const data = await window.api.leerRegistroJSON(archivo);
                            const reg = data; // Los registros est√°n directamente en el archivo, no en data.registros

                            if (!reg || !reg.paciente) continue;

                            let coincide = false;

                            if (criterio === 'identificacion') {
                                const idNumero = reg.paciente?.identificacion?.numero?.toString().toLowerCase() || '';
                                coincide = idNumero === valorBusqueda || idNumero.includes(valorBusqueda);
                            } else if (criterio === 'nombre') {
                                const nombreCompleto = reg.paciente?.nombreCompleto?.toLowerCase() || '';
                                coincide = nombreCompleto.includes(valorBusqueda);
                            } else if (criterio === 'ultima') {
                                // Para √∫ltima atenci√≥n, agregar todos los registros para luego ordenar
                                coincide = true;
                            }

                            if (coincide) {
                                resultados.push({ archivo, reg });
                            }
                        } catch (e) {
                            console.warn(`Error leyendo archivo ${archivo}:`, e);
                        }
                    }

                    // Procesar resultados seg√∫n criterio
                    if (criterio === 'ultima' && resultados.length > 0) {
                        // Ordenar por fecha de diligenciamiento descendente
                        resultados.sort((a, b) => {
                            const fechaA = a.reg.protocolo?.fechaDiligenciamiento || a.reg.metadata?.lastModified || '';
                            const fechaB = b.reg.protocolo?.fechaDiligenciamiento || b.reg.metadata?.lastModified || '';
                            return fechaB.localeCompare(fechaA);
                        });

                        // Si buscamos √∫ltima atenci√≥n, mostrar solo los 5 m√°s recientes
                        resultados = resultados.slice(0, 5);
                    }

                    mostrarResultados(resultados, resultadosDiv);

                } catch (error) {
                    console.error('Error en b√∫squeda:', error);
                    resultadosDiv.innerHTML = `<div style="color:#f44336;padding:10px;">Error: ${error.message}</div>`;
                }
            }

            function mostrarResultados(resultados, resultadosDiv) {
                if (resultados.length === 0) {
                    resultadosDiv.innerHTML = '<div style="color:#666;padding:10px;">No se encontraron registros que coincidan con la b√∫squeda.</div>';
                    return;
                }

                let html = `<div style="margin-bottom:10px;"><b>Se encontraron ${resultados.length} registro(s):</b></div>`;

                resultados.forEach((resultado, index) => {
                    const reg = resultado.reg;
                    const fechaNacimiento = reg.paciente?.fechaNacimiento ?
                        new Date(reg.paciente.fechaNacimiento).toLocaleDateString('es-ES') : 'No especificada';
                    const fechaUltimaAtencion = reg.protocolo?.fechaDiligenciamiento ?
                        new Date(reg.protocolo.fechaDiligenciamiento).toLocaleDateString('es-ES') :
                        (reg.metadata?.lastModified ? new Date(reg.metadata.lastModified).toLocaleDateString('es-ES') : 'No especificada');

                    html += `
                        <div style="border:1px solid #e0f2f1;border-radius:8px;margin-bottom:8px;padding:12px;background:#f8fffe;">
                            <div style="display:flex;justify-content:space-between;align-items:start;">
                                <div style="flex:1;">
                                    <div style="font-weight:600;color:#2c5454;margin-bottom:4px;">
                                        ${reg.paciente?.nombreCompleto || 'Nombre no especificado'}
                                    </div>
                                    <div style="font-size:0.9rem;color:#666;margin-bottom:2px;">
                                        <strong>ID:</strong> ${reg.paciente?.identificacion?.numero || 'No especificada'}
                                    </div>
                                    <div style="font-size:0.9rem;color:#666;margin-bottom:2px;">
                                        <strong>Fecha nacimiento:</strong> ${fechaNacimiento}
                                    </div>
                                    <div style="font-size:0.9rem;color:#666;">
                                        <strong>√öltima atenci√≥n:</strong> ${fechaUltimaAtencion}
                                    </div>
                                </div>
                                <button 
                                    class="btn btn-primary" 
                                    style="padding:8px 16px;font-size:0.9rem;margin-left:12px;" 
                                    onclick="seleccionarRegistroBusqueda(${index})">
                                    Seleccionar
                                </button>
                            </div>
                        </div>
                    `;
                });

                resultadosDiv.innerHTML = html;

                // Configurar funci√≥n de selecci√≥n
                window.resultadosBusqueda = resultados;
                window.seleccionarRegistroBusqueda = function (idx) {
                    const resultado = window.resultadosBusqueda[idx];
                    const reg = resultado.reg;

                    // Cargar datos al formulario
                    document.getElementById('identificacion').value = reg.paciente?.identificacion?.numero || '';
                    document.getElementById('nombre-usuario').value = reg.paciente?.nombreCompleto || '';
                    document.getElementById('fecha-nacimiento').value = reg.paciente?.fechaNacimiento || '';
                    document.getElementById('edad-anos').value = reg.paciente?.edadActual?.a√±os || '';
                    document.getElementById('edad-meses').value = reg.paciente?.edadActual?.meses || '';
                    document.getElementById('nombre-acudiente').value = reg.acudiente?.nombreCompleto || '';
                    document.getElementById('correo').value = reg.acudiente?.correoElectronico || '';
                    document.getElementById('telefono').value = reg.acudiente?.telefono || '';
                    document.getElementById('fecha-inicio').value = reg.protocolo?.fechaInicio || '';

                    // Mantener fecha de diligenciamiento actual para nuevas modificaciones
                    const fechaActual = new Date().toISOString().split('T')[0];
                    document.getElementById('fecha-diligenciamiento').value = fechaActual;

                    // Automatizaci√≥n: Recalcular par√°metros derivados
                    recalcularParametrosAutomaticos(reg);

                    // Guardar referencia al archivo original
                    window.registroOrigenPath = resultado.archivo;

                    // Establecer estados de evaluaci√≥n seg√∫n el registro cargado
                    if (reg.evaluaciones && reg.evaluaciones.estadoActual) {
                        sessionStorage.setItem('estadosEvaluacionCargados', JSON.stringify(reg.evaluaciones.estadoActual));
                    }

                    // Cerrar modal y actualizar indicadores
                    document.getElementById('modal-busqueda').remove();
                    updateCompletionStatus();

                    // Abrir la secci√≥n de Informaci√≥n del Paciente y enfocar el primer campo
                    setTimeout(() => {
                        const pacienteHeader = document.querySelector('.accordion-item[data-section="paciente"] .accordion-header');
                        if (pacienteHeader) {
                            expandAccordion(pacienteHeader);

                            // Enfocar el primer campo (identificaci√≥n)
                            setTimeout(() => {
                                const primerCampo = document.getElementById('identificacion');
                                if (primerCampo) {
                                    primerCampo.focus();
                                }
                            }, 150);
                        }

                        const grupoEtario = determinarGrupoEtario(reg.paciente?.edadActual || { a√±os: 0, meses: 0 });
                        console.log(`Registro cargado exitosamente. Datos autom√°ticamente recalculados: Grupo etario: ${grupoEtario}, Edad de inicio del protocolo, Estados de evaluaci√≥n`);
                    }, 100);
                }
            }

            document.getElementById('btn-continuar').addEventListener('click', function () {
                // Validar campo obligatorio
                const fechaDiligenciamiento = document.getElementById('fecha-diligenciamiento').value;
                if (!fechaDiligenciamiento) {
                    alert('Por favor complete el campo obligatorio: Fecha de diligenciamiento');
                    return;
                }

                // Recopilar datos del formulario
                const identificacion = document.getElementById('identificacion').value;
                const nombreUsuario = document.getElementById('nombre-usuario').value;
                const fechaNacimiento = document.getElementById('fecha-nacimiento').value;
                const edadAnos = document.getElementById('edad-anos').value;
                const edadMeses = document.getElementById('edad-meses').value;
                const nombreAcudiente = document.getElementById('nombre-acudiente').value;
                const correo = document.getElementById('correo').value;
                const telefono = document.getElementById('telefono').value;
                const fechaInicio = document.getElementById('fecha-inicio').value;

                // Generar UUID
                function generarUUID() {
                    if (window.crypto && window.crypto.randomUUID) {
                        return window.crypto.randomUUID();
                    } else {
                        // Fallback simple
                        return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function (c) {
                            var r = Math.random() * 16 | 0, v = c === 'x' ? r : (r & 0x3 | 0x8);
                            return v.toString(16);
                        });
                    }
                }
                const uuid = generarUUID();

                // Construir objeto registro compatible con el formulario de cumplimiento
                const registro = {
                    metadata: {
                        version: '1.0.0',
                        created: new Date().toISOString(),
                        lastModified: new Date().toISOString(),
                        application: 'Protocolo S√≠ndrome de Down - Electron App',
                        description: 'Registro generado desde formulario de identificaci√≥n'
                    },
                    codigoRegistro: uuid,
                    paciente: {
                        identificacion: {
                            numero: identificacion,
                            numeroFormateado: identificacion
                        },
                        nombreCompleto: nombreUsuario,
                        fechaNacimiento: fechaNacimiento,
                        edadActual: {
                            a√±os: parseInt(edadAnos) || 0,
                            meses: parseInt(edadMeses) || 0,
                            totalMeses: (parseInt(edadAnos) || 0) * 12 + (parseInt(edadMeses) || 0)
                        }
                    },
                    acudiente: {
                        nombreCompleto: nombreAcudiente,
                        correoElectronico: correo,
                        telefono: telefono
                    },
                    protocolo: {
                        fechaInicio: fechaInicio,
                        edadInicio: {},
                        fechaDiligenciamiento: fechaDiligenciamiento
                    }
                };

                // Guardar edad en sessionStorage para el formulario de cumplimiento
                const registroIdentificacion = {
                    paciente: {
                        identificacion: {
                            numero: identificacion,
                            numeroFormateado: identificacion
                        },
                        nombreCompleto: nombreUsuario,
                        fechaNacimiento: fechaNacimiento,
                        edadActual: {
                            a√±os: parseInt(edadAnos) || 0,
                            meses: parseInt(edadMeses) || 0,
                            totalMeses: (parseInt(edadAnos) || 0) * 12 + (parseInt(edadMeses) || 0)
                        }
                    },
                    acudiente: {
                        nombreCompleto: nombreAcudiente,
                        correoElectronico: correo,
                        telefono: telefono
                    },
                    protocolo: {
                        fechaInicio: fechaInicio,
                        edadInicio: {},
                        fechaDiligenciamiento: fechaDiligenciamiento
                    }
                };
                sessionStorage.setItem('registroIdentificacion', JSON.stringify(registroIdentificacion));

                // Determinar si se debe actualizar o crear nuevo registro
                (async () => {
                    console.log('Intentando guardar registro...');
                    if (!window.registroAPI) {
                        alert('No se encontr√≥ la API de registro. Verifica la configuraci√≥n de preload en Electron.');
                        console.error('window.registroAPI no est√° disponible');
                        return;
                    }
                    let resultado;
                    try {
                        let nombreArchivo;
                        if (window.registroOrigenPath) {
                            // Actualizar registro existente
                            nombreArchivo = window.registroOrigenPath;
                            if (!nombreArchivo.endsWith('.json')) {
                                nombreArchivo += '.json';
                            }
                            // Mantener el UUID del registro original si existe
                            if (window.resultadosBusqueda && window.resultadosBusqueda.length > 0) {
                                const registroOriginal = window.resultadosBusqueda.find(r => r.archivo === nombreArchivo);
                                if (registroOriginal && registroOriginal.reg.codigoRegistro) {
                                    registro.codigoRegistro = registroOriginal.reg.codigoRegistro;
                                }
                            }
                            console.log('Actualizando registro:', nombreArchivo);
                            resultado = await window.registroAPI.actualizarRegistro(registro, nombreArchivo);
                        } else {
                            // Crear nuevo registro
                            nombreArchivo = `registro-${uuid}.json`;
                            console.log('Creando nuevo registro:', nombreArchivo);
                            resultado = await window.registroAPI.guardarRegistro(registro, nombreArchivo);
                        }
                        // Guardar nombre de archivo en sessionStorage para uso en cumplimiento
                        sessionStorage.setItem('registroArchivo', nombreArchivo);
                        console.log('Resultado de guardado:', resultado);
                    } catch (err) {
                        alert('Error inesperado al intentar guardar el registro: ' + err);
                        console.error('Error inesperado:', err);
                        return;
                    }
                    if (resultado && resultado.success) {
                        window.location.href = 'formulario_cumplimiento.html';
                    } else {
                        alert('Error al guardar el registro: ' + (resultado && resultado.error ? resultado.error : 'Desconocido'));
                        console.error('Error al guardar:', resultado);
                    }
                })();
            });

            // Funci√≥n para recalcular autom√°ticamente los par√°metros derivados
            function recalcularParametrosAutomaticos(registro) {
                console.log('Recalculando par√°metros autom√°ticamente para el registro cargado');

                // Recalcular edad actual si hay fecha de nacimiento
                const fechaNacimiento = registro.paciente?.fechaNacimiento;
                if (fechaNacimiento) {
                    const hoy = new Date();
                    const fechaNac = new Date(fechaNacimiento);
                    calcularEdad(fechaNac, hoy, 'edad-anos', 'edad-meses');
                }

                // Recalcular edad de inicio del protocolo
                const fechaInicio = registro.protocolo?.fechaInicio;
                if (fechaInicio && fechaNacimiento) {
                    const fechaNac = new Date(fechaNacimiento);
                    const fechaIni = new Date(fechaInicio);
                    calcularEdad(fechaNac, fechaIni, 'edad-inicio-anos', 'edad-inicio-meses');
                }

                // Validar y actualizar indicadores de completado
                updateCompletionStatus();

                console.log('Par√°metros recalculados exitosamente');
            }

            // Funci√≥n para determinar grupo etario
            function determinarGrupoEtario(edadActual) {
                const totalMeses = (edadActual.a√±os || 0) * 12 + (edadActual.meses || 0);

                if (totalMeses === 0) return "RN";
                if (totalMeses <= 6) return "1 a 6 meses";
                if (totalMeses <= 12) return "7 a 12 meses";
                if (totalMeses <= 18) return "1 a√±o y medio";
                if (totalMeses <= 24) return "Dos a√±os";
                if (totalMeses <= 36) return "Tres a√±os";
                if (totalMeses <= 48) return "Cuatro a√±os";
                if (totalMeses <= 60) return "Cinco a√±os";
                if (totalMeses <= 72) return "Seis a√±os";
                if (totalMeses <= 84) return "Siete a√±os";
                if (totalMeses <= 96) return "Ocho a√±os";
                if (totalMeses <= 108) return "Nueve a√±os";
                if (totalMeses <= 120) return "Diez a√±os";
                if (totalMeses <= 156) return "De once a trece a√±os";
                return "De catorce a dieciocho a√±os";
            }

            // Actualizar estado inicial
            updateCompletionStatus();
        });
    </script>
</body>

</html>